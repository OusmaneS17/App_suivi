{% extends "dashboard_app/base.html" %}


{% block titre%} Dashboard Coordonnateur {% endblock %}

{% block content %}

{% load static %}


  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg ">
  

  <!-- Navbar -->
    <br>
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-3 shadow-sm border-radius-xl position-sticky blur border-radius-lg" id="navbarBlur" data-scroll="true" style="backdrop-filter: blur(10px); z-index: 1030;">
      <div class="container-fluid py-1 px-3">
        <div class="navbar-brand d-flex align-items-center">
          <span class="font-weight-bold text-lg" style="color: #004600;">Bonjour, <span  style="color: #004600;"> {{ request.user.username }}</span></span>
        </div>
        
        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4 justify-content-end" id="navbar">
          <ul class="navbar-nav d-flex align-items-center">
            
            
            
            <!-- User Profile Dropdown -->
            <li class="nav-item dropdown d-flex align-items-center ps-2">
              <a href="javascript:;" class="nav-link text-body font-weight-bold px-0 d-flex align-items-center" id="userProfileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="material-symbols-rounded me-2 text-dark cursor-pointer transition-all hover:text-success">account_circle</i>
                <span class="d-none d-sm-inline text-sm text-dark">{{ request.user.username }}</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end px-2 py-3 me-sm-n4 animate__animated animate__fadeIn animate__faster" aria-labelledby="userProfileDropdown">
                <li class="mb-2">
                  <a class="dropdown-item border-radius-md transition-all hover:bg-gray-100" href="{% url 'profile' %}">
                    <div class="d-flex py-1 align-items-center" >
                      <i class="material-symbols-rounded text-primary me-3">person</i>
                      <h6 class="text-sm font-weight-normal mb-0 text-dark">
                        Mon Profil
                      </h6>
                    </div>
                  </a>
                </li>
                <!-- <li class="mb-2">
                  <a class="dropdown-item border-radius-md transition-all hover:bg-gray-100" href="javascript:;">
                    <div class="d-flex py-1 align-items-center">
                      <i class="material-symbols-rounded text-success me-3">settings</i>
                      <h6 class="text-sm font-weight-normal mb-0 text-dark">
                        Paramètres
                      </h6>
                    </div>
                  </a>
                </li> -->
                <li>
                  <a class="dropdown-item border-radius-md transition-all hover:bg-gray-100" href="{% url 'log_out' %}">
                    <div class="d-flex py-1 align-items-center">
                      <i class="material-symbols-rounded text-success me-3">logout</i>
                      <h6 class="text-sm font-weight-normal mb-0 text-dark">
                        Déconnexion
                      </h6>
                    </div>
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- End Navbar -->
    <div class="container-fluid py-2">
      <!-- premier ligne -->
      <div class="row">
        <div class="row g-1">
          <!-- Carte 1 - Ministère -->
          <div class="col-xl-2 col-lg-4 col-md-4 col-sm-6 mb-1">
            <div class="card h-100 mb-0 shadow-sm border-0" style="background-color: #f8f9fa;">
              <div class="card-header p-2" style="background: linear-gradient(135deg, #004600, #007a00); font-weight: 600; color: white; border-top-left-radius: .5rem; border-top-right-radius: .5rem;">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="dropdown">
                      <button class="btn btn-sm dropdown-toggle mb-0 fw-bold" style="color: #495057; background: #f8f9fa; border: 1px solid #ced4da; width: 100%; text-align: left;" type="button" id="dropdownL1Button" data-bs-toggle="dropdown" aria-expanded="false">
                          <span id="selectedL1">Tous</span>
                      </button>
                      <ul class="dropdown-menu" aria-labelledby="dropdownL1Button" id="l1DropdownMenu">
                          <li><a class="dropdown-item" href="#" onclick="updateL1Filter('all', 'Tous'); return false;">Tous</a></li>
                          <li><a class="dropdown-item" href="#" onclick="updateL1Filter('axe', 'Axe'); return false;">Axe</a></li>
                          <li><a class="dropdown-item" href="#" onclick="updateL1Filter('portefeuille', 'Portefeuille'); return false;">Portefeuille</a></li>
                          <li><a class="dropdown-item" href="#" onclick="updateL1Filter('ministere', 'Ministère responsable'); return false;">Ministère responsable</a></li>
                      </ul>
                  </div>
                  <div class="icon icon-sm icon-shape bg-white shadow-sm text-center rounded-circle" style="color: #004600;">
                    <i class="material-symbols-rounded opacity-10" style="color: #004600;">widgets</i>
                  </div>
                </div>
              </div>
              <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
              <script>
                $(document).ready(function() {
                  $(".dropdown-item").click(function(e) {
                    e.preventDefault();
                    var modalite = $(this).text();
                    $("#selectedModalite").text(modalite);
                    $(".dropdown-toggle").dropdown('hide');
                  });
                });
              </script>
          
              <hr class="my-1 mx-3" style="border-top: 1px solid #004600;">
          
              <div class="dropdown card-footer p-2 border-top-0">
                <button class="btn btn-outline-success dropdown-toggle w-100 d-flex align-items-center justify-content-between" style="min-height: 46px; border-color: #004600; color: #004600;" type="button" id="dropdownL2Button" data-bs-toggle="dropdown" aria-expanded="false" disabled>
                    <span id="selectedL2" class="text-wrap me-2" style="white-space: normal; text-align: left;">Sélectionnez d'abord le niveau 1</span>
                </button>
                <ul class="dropdown-menu w-100" aria-labelledby="dropdownL2Button" id="l2DropdownMenu">
                    <li><a class="dropdown-item" href="#">Sélectionnez d'abord le niveau 1</a></li>
                </ul>
              </div>
            </div>
          </div>
          
          <!-- Carte 3 - Nbre programmes -->
          <div class="col-xl-2 col-lg-4 col-md-4 col-sm-6 mb-1">
            <div class="card h-100 mb-0 shadow-sm border-0" style="background-color: #f8f9fa;">
              <div class="card-header p-2" style="background: linear-gradient(135deg, #004600, #007a00); font-weight: 600; color: white; border-top-left-radius: .5rem; border-top-right-radius: .5rem;">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="mb-0 fw-bold" style="color: #ffffff">Nbre programmes</h6>
                  <div class="icon icon-sm icon-shape bg-white shadow-sm text-center rounded-circle" style="color: #004600;">
                    <i class="material-symbols-rounded opacity-10"  style="color: #004600;">leaderboard</i>
                  </div>
                </div>
              </div>
          
              <hr class="my-1 mx-3" style="border-top: 1px solid #004600;">
          
              <div class="card-footer p-2 border-top-0">
                <h1 class="mb-0 fw-bold text-center" style="color: #004600;font-size: 3rem;" id="program-count">
                  
                </h1>
              </div>
            </div>
          </div>
          
          <!-- Carte 4 - Nbre projets -->
          <div class="col-xl-2 col-lg-4 col-md-4 col-sm-6 mb-1">
            <div class="card h-100 mb-0 shadow-sm border-0" style="background-color: #f8f9fa;">
              <div class="card-header p-2" style="background: linear-gradient(135deg, #004600, #007a00); font-weight: 600; color: white; border-top-left-radius: .5rem; border-top-right-radius: .5rem;">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="mb-0 fw-bold" style="color: #ffffff">Nombre de projets</h6>
                  <div class="icon icon-sm icon-shape bg-white shadow-sm text-center rounded-circle" style="color: #004600;">
                    <i class="material-symbols-rounded opacity-10" style="color: #004600;">leaderboard</i>
                  </div>
                </div>
              </div>
          
              <hr class="my-1 mx-3" style="border-top: 1px solid #004600;">
          
              <div class="card-footer p-2 border-top-0">
                <h1 class="mb-0 fw-bold text-center" style="color: #004600;font-size: 3rem;" id="project-count"> </h1>
              </div>
            </div>
          </div>
          
        
          <!-- Carte 5 - Projets démarrés -->
          <div class="col-xl-2 col-lg-4 col-md-4 col-sm-6 mb-1">
            <div class="card h-100 mb-0 shadow-sm border-0" style="background-color: #f8f9fa;">
              <div class="card-header p-2" style="background: linear-gradient(135deg, #004600, #007a00); font-weight: 600; color: white; border-top-left-radius: .5rem; border-top-right-radius: .5rem;">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="mb-0 fw-bold" style="color: #ffffff">Projets démarrés</h6>
                  <div class="icon icon-sm icon-shape bg-white shadow-sm text-center rounded-circle" style="color: #004600;">
                    <i class="material-symbols-rounded opacity-10" style="color: #004600;">leaderboard</i>
                  </div>
                </div>
              </div>
          
              <hr class="my-1 mx-3" style="border-top: 1px solid #004600;">
          
              <div class="card-footer p-2 border-top-0">
                <h1 class="mb-0 fw-bold text-center" style="color: #004600;font-size: 3rem;" id="started-project-count"></h1>
              </div>
            </div>
          </div>

          <!-- Carte 2 - Nombre de composante démarrés -->
          <div class="col-xl-2 col-lg-4 col-md-4 col-sm-6 mb-1">
            <div class="card h-100 mb-0 shadow-sm border-0" style="background-color: #f8f9fa;">
              <div class="card-header p-2" style="background: linear-gradient(135deg, #004600, #007a00); font-weight: 600; color: white; border-top-left-radius: .5rem; border-top-right-radius: .5rem;">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="mb-0 fw-bold" style="color: #ffffff">Composantes démarées</h6>
                  <div class="icon icon-sm icon-shape bg-white shadow-sm text-center rounded-circle" style="color: #004600;">
                    <i class="material-symbols-rounded opacity-10" style="color: #004600;">leaderboard</i>
                  </div>
                </div>
              </div>
          
              <hr class="my-1 mx-3" style="border-top: 1px solid #004600;">
          
              <div class="card-footer p-2 border-top-0">
                <h6 class="mb-0 text-truncate text-center" style="color: #004600;font-size: 3rem;" id="started-composante-count">
                </h6>
              </div>
            </div>
          </div>

          <!-- Carte 6 - États des projets -->
          <div class="col-xl-2 col-lg-4 col-md-4 col-sm-6 mb-1">
            <div class="card h-100 mb-0 shadow-sm border-0" style="background-color: #f8f9fa;">          
              <div class="card-body p-2">
                <table class="table table-sm table-borderless mb-0 h-100">
                  <tbody>
                    <tr class="align-middle">
                      <td>
                        <div class="d-flex align-items-center">
                          <i class="material-symbols-rounded me-2" style="color: #198754;">check_circle</i>
                          <span class="fw-bold text-dark">Satisfaisant</span>
                        </div>
                      </td>
                      <td class="text-end fw-bold text-dark" id="satisfaisant-composante-count">0</td>
                    </tr>
                    <tr class="align-middle">
                      <td>
                        <div class="d-flex align-items-center">
                          <i class="material-symbols-rounded me-2" style="color: #ffc107;">warning</i>
                          <span class="fw-bold text-dark">Alerte</span>
                        </div>
                      </td>
                      <td class="text-end fw-bold text-dark" id="alerte-composante-count">0</td>
                    </tr>
                    <tr class="align-middle">
                      <td>
                        <div class="d-flex align-items-center">
                          <i class="material-symbols-rounded me-2" style="color: #dc3545;">block</i>
                          <span class="fw-bold text-dark">Bloqué</span>
                        </div>
                      </td>
                      <td class="text-end fw-bold text-dark" id="bloque-composante-count">0</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
        </div>
      </div>
      
      <!-- Deuxième ligne -->
      <br>
      <ul class="nav nav-tabs mb-4 border-bottom border-2" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <a class="nav-link active fw-bold text-success" id="single-message-tab" data-bs-toggle="tab" href="#single-message" role="tab" aria-controls="single-message" aria-selected="true">
            <i class="fas fa-envelope me-2"></i>1 message/semaine
          </a>
        </li>
        <li class="nav-item" role="presentation">
          <a class="nav-link fw-bold text-success" id="double-message-tab" data-bs-toggle="tab" href="#double-message" role="tab" aria-controls="double-message" aria-selected="false">
            <i class="fas fa-envelope-open-text me-2"></i>2 messages/semaine
          </a>
        </li>
      </ul>

      <div class="tab-content" id="dashboardTabsContent">
        <!-- Single message tab -->
        <div class="tab-pane fade show active" id="single-message" role="tabpanel" aria-labelledby="single-message-tab">
          <div class="card shadow-sm border-0 rounded-3">
            <div class="card-body">
              <!-- Header with Axe and Quarter -->
              <div class="row align-items-center mb-4">
                <!-- <div class="col-md-3">
                  <label class="form-label text-success fw-bold">
                    <i class="fas fa-project-diagram me-2"></i>Axe
                  </label>
                  <div class="card bg-light-success border-start border-success border-3">
                    <div class="card-body p-2">
                      <select class="form-select border-0 bg-light-success text-success fw-bold">
                        <option>Sélectionner un axe</option>
                      </select>
                    </div>
                  </div>
                </div> -->

                <div class="col-md-4">
                  <label class="form-label text-success fw-bold">
                    <i class="fas fa-calendar-alt me-2"></i>Trimestre
                  </label>
                      <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="trimestre" id="trimestre_t1" value="1" autocomplete="off" checked>
                        <label class="btn btn-outline-success" for="trimestre_t1">T1</label>
                        
                        <input type="radio" class="btn-check" name="trimestre" id="trimestre_t2" value="2" autocomplete="off">
                        <label class="btn btn-outline-success" for="trimestre_t2">T2</label>
                        
                        <input type="radio" class="btn-check" name="trimestre" id="trimestre_t3" value="3" autocomplete="off">
                        <label class="btn btn-outline-success" for="trimestre_t3">T3</label>
                        
                        <input type="radio" class="btn-check" name="trimestre" id="trimestre_t4" value="4" autocomplete="off">
                        <label class="btn btn-outline-success" for="trimestre_t4">T4</label>
                      </div>
                </div>
              </div>
              
              <hr class="border-success opacity-25">
              
              <!-- Main content -->
              <div class="row g-3">
                <!-- Filters column -->
                <div class="col-xl-3 col-md-6">
                  <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                      <h5 class="card-title text-success">
                        <i class="fas fa-filter me-2"></i>Filtres
                      </h5>
                      
                      <!-- Programme filter -->
                      <div class="mb-3">
                        <label class="form-label text-muted small">Programme</label>
                        <div class="dropdown">
                          <button class="btn btn-light-success w-100 text-start d-flex justify-content-between align-items-center py-2" 
                                  type="button" id="dropdownL3Button" data-bs-toggle="dropdown">
                            <span id="selectedL3">Sélectionnez un programme</span>
                            <i class="fas fa-chevron-down text-success"></i>
                          </button>
                          <ul class="dropdown-menu w-100" aria-labelledby="dropdownL3Button" id="l3DropdownMenu">
                            <!-- Options will be populated here -->
                          </ul>
                        </div>
                      </div>
                      
                      <!-- Project filter -->
                      <div class="mb-3">
                        <label class="form-label text-muted small">Projet</label>
                        <div class="dropdown">
                          <button class="btn btn-light-success w-100 text-start d-flex justify-content-between align-items-center py-2" 
                                  type="button" id="dropdownL4Button" data-bs-toggle="dropdown">
                            <span id="selectedL4">Sélectionnez un projet</span>
                            <i class="fas fa-chevron-down text-success"></i>
                          </button>
                          <ul class="dropdown-menu w-100"  aria-labelledby="dropdownL4Button" id="l4DropdownMenu">
                            <!-- Options will be populated here -->
                          </ul>
                        </div>
                      </div>

                      
                      <!-- Component filter -->
                      <div class="mb-3">
                        <label class="form-label text-muted small">Composante</label>
                        <div class="dropdown">
                          <button class="btn btn-light-success w-100 text-start d-flex justify-content-between align-items-center py-2" 
                                  type="button" id="dropdownL5Button" data-bs-toggle="dropdown">
                            <span  id="selectedL5">Sélectionnez une composante</span>
                            <i class="fas fa-chevron-down text-success"></i>
                          </button>
                          <ul class="dropdown-menu w-100" aria-labelledby="dropdownL5Button" id="l5DropdownMenu">
                            <!-- Options will be populated here -->
                          </ul>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Project info column -->
                <div class="col-xl-3 col-md-6">
                  <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                      <h5 class="card-title text-success">
                        <i class="fas fa-info-circle me-2"></i>Informations
                      </h5>
                      
                      
                      <!-- Implementation card -->
                      <div class="card bg-light-success border-0 mt-3">
                        <div class="card-header bg-success text-white fw-bold">
                          Mise en œuvre
                        </div>
                        <div class="card-body text-center py-4">
                          <img src="{% static '/assets/img/ministere_mise_en_oeuvre.png' %}" 
                              id="logoMise3" class="img-fluid" style="max-height: 60px;" 
                              alt="Logo mise en œuvre">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Metrics column -->
                <div class="col-xl-3 col-md-6">
                  <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                      <h5 class="card-title text-success">
                        <i class="fas fa-chart-line me-2"></i>Indicateurs
                      </h5>
                      
                      <div class="row g-2">
                        <!-- Progress metric -->
                        <div class="col-6">
                          <div class="card border-0 bg-white h-100">
                            <div class="card-body text-center">
                              <h6 class="text-success fw-bold">Avancement</h6>
                              <div class="progress-circle-container mx-auto my-2">
                                <svg viewBox="0 0 36 36" class="circular-chart">
                                  <!-- Background circle -->
                                  <circle class="circle-bg" cx="18" cy="18" r="15.9155" fill="none" stroke-width="3"/>
                                  <!-- Progress circle - now using circle element for easier calculations -->
                                  <circle class="circle-fill" cx="18" cy="18" r="15.9155" fill="none" stroke-width="3" 
                                          stroke-linecap="round" stroke-dasharray="0 100"/>
                                  <!-- Percentage text -->
                                  <text x="18" y="20.5" class="percentage" id="phy-reel-val0">0%</text>
                                </svg>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Target metric -->
                        <div class="col-6">
                          <div class="card border-0 bg-white h-100">
                            <div class="card-body text-center">
                              <h6 class="text-success fw-bold">Cible trim</h6>
                              <div class="progress-circle-container mx-auto my-2" data-value="0">
                                <svg viewBox="0 0 36 36" class="circular-chart">
                                  <!-- Background circle -->
                                  <circle class="circle-bg" cx="18" cy="18" r="15.9155" fill="none" stroke-width="3"/>
                                  <!-- Progress circle - now using circle element for easier calculations -->
                                  <circle class="circle-fill" cx="18" cy="18" r="15.9155" fill="none" stroke-width="3" 
                                          stroke-linecap="round" stroke-dasharray="0 100"/>
                                  <!-- Percentage text -->
                                  <text x="18" y="20.5" class="percentage" id="phy-prev-val0">0%</text>
                                </svg>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Disbursement metric -->
                        <div class="col-6">
                          <div class="card border-0 bg-white h-100">
                            <div class="card-body text-center">
                              <h6 class="text-success fw-bold">Décaissement</h6>
                              <div class="progress-circle-container mx-auto my-2" data-value="0">
                                <svg viewBox="0 0 36 36" class="circular-chart">
                                  <!-- Background circle -->
                                  <circle class="circle-bg" cx="18" cy="18" r="15.9155" fill="none" stroke-width="3"/>
                                  <!-- Progress circle - now using circle element for easier calculations -->
                                  <circle class="circle-fill" cx="18" cy="18" r="15.9155" fill="none" stroke-width="3" 
                                          stroke-linecap="round" stroke-dasharray="0 100"/>
                                  <!-- Percentage text -->
                                  <text x="18" y="20.5" class="percentage" id="dec-reel-val0">0%</text>
                                </svg>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Disbursement target -->
                        <div class="col-6">
                          <div class="card border-0 bg-white h-100">
                            <div class="card-body text-center">
                              <h6 class="text-success fw-bold">Cible trim dec</h6>
                              <div class="progress-circle-container mx-auto my-2" data-value="0">
                                <svg viewBox="0 0 36 36" class="circular-chart">
                                  <!-- Background circle -->
                                  <circle class="circle-bg" cx="18" cy="18" r="15.9155" fill="none" stroke-width="3"/>
                                  <!-- Progress circle - now using circle element for easier calculations -->
                                  <circle class="circle-fill" cx="18" cy="18" r="15.9155" fill="none" stroke-width="3" 
                                          stroke-linecap="round" stroke-dasharray="0 100"/>
                                  <!-- Percentage text -->
                                  <text x="18" y="20.5" class="percentage" id="dec-prev-val0">0%</text>
                                </svg>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Message column -->
                <div class="col-xl-3 col-md-6">
                  <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                      <span class="fw-bold">
                        <i class="fas fa-comment-alt me-2"></i>Message de la semaine
                      </span>
                      <a href="{% url 'tables_sub5' %}" class="text-white">
                        <i class="fas fa-edit"></i>
                      </a>
                    </div>
                    <div class="card-body bg-light-success">
                      <div class="message-content text-success"  id="messages-container">
                        <p class="mb-0">Lecture du message...</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Double message tab -->
        <!-- 2 messages dans la semaine -->
        <div class="tab-pane fade" id="double-message" role="tabpanel" aria-labelledby="double-message-tab">
          <div class="card shadow-sm border-0 rounded-3">
            <div class="card-body">
              <!-- En-tête commune -->
              <div class="row align-items-center mb-4">
                <!--<div class="col-md-3">
                  <label class="form-label text-success fw-bold">
                    <i class="fas fa-project-diagram me-2"></i>Axe
                  </label>
                  <select class="form-select border-success bg-light-success">
                    <option>Sélectionner un axe</option>
                  </select>
                </div> -->
                
                <div class="col-md-4">
                  <label class="form-label text-success fw-bold">
                    <i class="fas fa-calendar-alt me-2"></i>Trimestre
                  </label>
                  <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="trimestre_2" id="t1" value="1" checked>
                    <label class="btn btn-outline-success" for="t1">T1</label>

                    <input type="radio" class="btn-check" name="trimestre_2" id="t2" value="2">
                    <label class="btn btn-outline-success" for="t2">T2</label>
                    
                    <input type="radio" class="btn-check" name="trimestre_2" id="t3" value="3">
                    <label class="btn btn-outline-success" for="t3">T3</label>

                    <input type="radio" class="btn-check" name="trimestre_2" id="t4" value="4">
                    <label class="btn btn-outline-success" for="t4">T4</label>
                  </div>
                </div>
              </div>

              <hr class="border-success opacity-25 my-4">

              <!-- Grille des 2 projets -->
              <div class="row g-4">
                <!-- Projet 1 -->
                <div class="col-lg-6">
                  <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                      <div class="row g-3">
                        <!-- Filtres -->
                        <div class="col-md-6">
                          <!-- Programme -->
                          <div class="mb-3">
                            <label class="form-label text-muted small">Programme</label>
                            <div class="dropdown">
                              <button class="btn btn-light-success w-100 text-start d-flex justify-content-between align-items-center py-2" 
                                      type="button" id="dropdownL3Button_1" data-bs-toggle="dropdown">
                                <span id="selectedL3_1">Sélectionnez un programme</span>
                                <i class="fas fa-chevron-down text-success"></i>
                              </button>
                              <ul class="dropdown-menu w-100" aria-labelledby="dropdownL3Button_1" id="l3DropdownMenu_1">
                                <!-- Options will be populated here -->
                              </ul>
                            </div>
                          </div>

                          <!-- Projet -->
                          <div class="mb-3">
                            <label class="form-label text-muted small">Projet</label>
                            <div class="dropdown">
                              <button class="btn btn-light-success w-100 text-start d-flex justify-content-between align-items-center py-2" 
                                      type="button" id="dropdownL4Button_1" data-bs-toggle="dropdown">
                                <span id="selectedL4_1">Sélectionnez un projet</span>
                                <i class="fas fa-chevron-down text-success"></i>
                              </button>
                              <ul class="dropdown-menu w-100"  aria-labelledby="dropdownL4Button_1" id="l4DropdownMenu_1">
                                <!-- Options will be populated here -->
                              </ul>
                            </div>
                          </div>

                          <!-- Composante -->
                          <div class="mb-3">
                            <label class="form-label text-muted small">Composante</label>
                            <div class="dropdown">
                              <button class="btn btn-light-success w-100 text-start d-flex justify-content-between align-items-center py-2" 
                                      type="button" id="dropdownL5Button_1" data-bs-toggle="dropdown">
                                <span  id="selectedL5_1">Sélectionnez une composante</span>
                                <i class="fas fa-chevron-down text-success"></i>
                              </button>
                              <ul class="dropdown-menu w-100" aria-labelledby="dropdownL5Button_1" id="l5DropdownMenu_1">
                                <!-- Options will be populated here -->
                              </ul>
                            </div>
                          </div>

                          <!-- Mise en oeuvre -->
                          <div class="card bg-light-success border-0 mt-3">
                            <div class="card-header bg-success text-white fw-bold">
                              Mise en œuvre
                            </div>
                            <div class="card-body text-center py-4">
                              <img src="{% static '/assets/img/ministere_mise_en_oeuvre.png' %}" 
                                  id="logoMise1" class="img-fluid" style="max-height: 60px;" 
                                  alt="Logo mise en œuvre">
                            </div>
                          </div>
                        </div>
                        
                        <!-- Métriques -->
                        <div class="col-md-6">
                          <div class="metric-grid">
                            <div class="metric-card">
                              <div class="metric-title">Avancement</div>
                              <div class="progress mt-2" style="height: 8px;">
                                <div class="progress-bar bg-success" id="phy-reel-bar1" style="width: 0%"></div>
                              </div>
                              <div class="text-end small text-success mt-1" id="phy-reel-val1">0%</div>
                            </div>
                            
                            <div class="metric-card mt-3">
                              <div class="metric-title">Cible trim</div>
                              <div class="progress mt-2" style="height: 8px;">
                                <div class="progress-bar bg-success" id="phy-prev-bar1" style="width: 0%"></div>
                              </div>
                              <div class="text-end small text-success mt-1" id="phy-prev-val1">0%</div>
                            </div>
                            
                            <div class="metric-card mt-3">
                              <div class="metric-title">Décaissement</div>
                              <div class="progress mt-2" style="height: 8px;">
                                <div class="progress-bar bg-success" id="dec-reel-bar1" style="width: 0%"></div>
                              </div>
                              <div class="text-end small text-success mt-1" id="dec-reel-val1">0%</div>
                            </div>
                            
                            <div class="metric-card mt-3">
                              <div class="metric-title">Cible trim dec</div>
                              <div class="progress mt-2" style="height: 8px;">
                                <div class="progress-bar bg-success" id="dec-prev-bar1" style="width: 0%"></div>
                              </div>
                              <div class="text-end small text-success mt-1" id="dec-prev-val1">0%</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Projet 2 -->
                <div class="col-lg-6">
                  <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                      <div class="row g-3">
                        <!-- Filtres -->
                        <div class="col-md-6">
                          <!-- Programme -->
                          <div class="mb-3">
                            <label class="form-label text-muted small">Programme</label>
                            <div class="dropdown">
                              <button class="btn btn-light-success w-100 text-start d-flex justify-content-between align-items-center py-2" 
                                      type="button" id="dropdownL3Button_2" data-bs-toggle="dropdown">
                                <span id="selectedL3_2">Sélectionnez un programme</span>
                                <i class="fas fa-chevron-down text-success"></i>
                              </button>
                              <ul class="dropdown-menu w-100" aria-labelledby="dropdownL3Button_2" id="l3DropdownMenu_2">
                                <!-- Options will be populated here -->
                              </ul>
                            </div>
                          </div>

                          <!-- Projet -->
                          <div class="mb-3">
                            <label class="form-label text-muted small">Projet</label>
                            <div class="dropdown">
                              <button class="btn btn-light-success w-100 text-start d-flex justify-content-between align-items-center py-2" 
                                      type="button" id="dropdownL4Button_2" data-bs-toggle="dropdown">
                                <span id="selectedL4_2">Sélectionnez un projet</span>
                                <i class="fas fa-chevron-down text-success"></i>
                              </button>
                              <ul class="dropdown-menu w-100"  aria-labelledby="dropdownL4Button_2" id="l4DropdownMenu_2">
                                <!-- Options will be populated here -->
                              </ul>
                            </div>
                          </div>

                          <!-- Composante -->
                          <div class="mb-3">
                            <label class="form-label text-muted small">Composante</label>
                            <div class="dropdown">
                              <button class="btn btn-light-success w-100 text-start d-flex justify-content-between align-items-center py-2" 
                                      type="button" id="dropdownL5Button_2" data-bs-toggle="dropdown">
                                <span  id="selectedL5_2">Sélectionnez une composante</span>
                                <i class="fas fa-chevron-down text-success"></i>
                              </button>
                              <ul class="dropdown-menu w-100" aria-labelledby="dropdownL5Button_2" id="l5DropdownMenu_2">
                                <!-- Options will be populated here -->
                              </ul>
                            </div>
                          </div>

                          <!-- Mise en oeuvre -->
                          <div class="card bg-light-success border-0 mt-3">
                            <div class="card-header bg-success text-white fw-bold">
                              Mise en œuvre
                            </div>
                            <div class="card-body text-center py-4">
                              <img src="{% static '/assets/img/ministere_mise_en_oeuvre.png' %}" 
                                  id="logoMise2" class="img-fluid" style="max-height: 60px;" 
                                  alt="Logo mise en œuvre">
                            </div>
                          </div>
                        </div>
                        
                        <!-- Métriques -->
                        <div class="col-md-6">
                          <div class="metric-grid">
                            <div class="metric-card">
                              <div class="metric-title">Avancement</div>
                              <div class="progress mt-2" style="height: 8px;">
                                <div class="progress-bar bg-success" id="phy-reel-bar2" style="width: 0%"></div>
                              </div>
                              <div class="text-end small text-success mt-1" id="phy-reel-val2">0%</div>
                            </div>
                            
                            <div class="metric-card mt-3">
                              <div class="metric-title">Cible trim</div>
                              <div class="progress mt-2" style="height: 8px;">
                                <div class="progress-bar bg-success" id="phy-prev-bar2" style="width: 0%"></div>
                              </div>
                              <div class="text-end small text-success mt-1" id="phy-prev-val2">0%</div>
                            </div>
                            
                            <div class="metric-card mt-3">
                              <div class="metric-title">Décaissement</div>
                              <div class="progress mt-2" style="height: 8px;">
                                <div class="progress-bar bg-success" id="dec-reel-bar2" style="width: 0%"></div>
                              </div>
                              <div class="text-end small text-success mt-1" id="dec-reel-val2">0%</div>
                            </div>
                            
                            <div class="metric-card mt-3">
                              <div class="metric-title">Cible trim dec</div>
                              <div class="progress mt-2" style="height: 8px;">
                                <div class="progress-bar bg-success" id="dec-prev-bar2" style="width: 0%"></div>
                              </div>
                              <div class="text-end small text-success mt-1" id="dec-prev-val2">0%</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Messages -->
                <div class="col-md-6">
                  <div class="card h-100 border-0 shadow-sm">
                    <div class="card-header bg-success text-white d-flex justify-content-between" style="height:40px;">
                      <span>Message 1</span>
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="card-body bg-light-success">
                      <div class="message-content" id="messages-container1">
                        Contenu du premier message...
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="card h-100 border-0 shadow-sm">
                    <div class="card-header bg-success text-white d-flex justify-content-between" style="height:40px;">
                      <span>Message 2</span>
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="card-body bg-light-success">
                      <div class="message-content" id="messages-container2">
                        Contenu du deuxième message...
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <style>
          /* Styles spécifiques à cette section */
          .metric-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
          }
          
          .metric-card {
            background-color: white;
            padding: 0.75rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,70,0,0.1);
          }
          
          .metric-title {
            font-size: 0.85rem;
            color: #004600;
            font-weight: 600;
          }
          
          .bg-light-success {
            background-color: #f8fdf8;
          }
          
          @media (max-width: 992px) {
            .card-body .row {
              flex-direction: column;
            }
            
            .col-md-6 {
              width: 100%;
            }
          }
        </style>
      </div>

      <style>
        /* Custom styles */
        .text-success {
          color: #004600 !important;
        }
        
        .bg-light-success {
          background-color: #f8fdf8 !important;
        }
        
        .btn-light-success {
          background-color: #f1f5f1;
          border: 1px solid #004600;
          color: #004600;
        }
        
        .btn-light-success:hover {
          background-color: #e0f0e0;
        }
        
        /* Progress circle styles */
        .progress-circle {
          width: 100px;
          height: 100px;
          margin: 0 auto;
        }
        
        .circular-chart {
          display: block;
          margin: 10px auto;
          max-width: 80%;
          max-height: 100px;
        }

        .circle-bg {
          stroke: #e0f0e0;
        }

        .circle-fill {
          stroke: #004600;
          transition: stroke-dasharray 0.6s ease-out; /* Smooth transition */
          transform-origin: 50% 50%; /* Centre de rotation */
          transform: rotate(-90deg);
        }

        .percentage {
          fill: #004600;
          font-size: 0.5em;
          text-anchor: middle;
          font-weight: bold;
        }
        @keyframes progress {
          0% {
            stroke-dasharray: 0, 100;
          }
        }
        
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
          .progress-circle {
            width: 80px;
            height: 80px;
          }
        }
      </style>
=
      <!-- Troisième ligne-->
      <div class="row">
        <div class="col-lg-12 col-md-6 mt-4 mb-4">
          <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
              <div class="card-body p-4">
              <!-- Filtre Trimestre amélioré -->
              
              <div class="row mb-4">
                <div class="col-md-8 mx-auto">
                  <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                    <div class="card-body p-3 bg-light bg-opacity-10">
                      <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-3">
                        <!-- Titre avec icône -->
                        <div class="d-flex align-items-center">
                          <div class="bg-success bg-opacity-10 p-2 rounded-circle me-2">
                            <i class="bi bi-calendar-range fs-5 text-success"></i>
                          </div>
                          <h6 class="mb-0 text-muted fw-semibold">
                            Sélection du trimestre
                          </h6>
                        </div>
                        
                        <!-- Boutons radio améliorés -->
                        <div class="d-flex flex-wrap gap-2 justify-content-center">
                          <div class="btn-group btn-group-toggle shadow-sm" role="group" data-toggle="buttons">
                            <input type="radio" class="btn-check" name="trim" id="tr1" value="1" autocomplete="off">
                            <label class="btn btn-outline-success px-3 py-2 rounded-start-pill d-flex align-items-center" for="tr1">
                              <i class="bi bi-1-circle me-2 d-none d-sm-inline"></i>
                              <span>T1</span>
                            </label>
                            
                            <input type="radio" class="btn-check" name="trim" id="tr2" value="2" autocomplete="off" checked>
                            <label class="btn btn-outline-success px-3 py-2 d-flex align-items-center" for="tr2">
                              <i class="bi bi-2-circle me-2 d-none d-sm-inline"></i>
                              <span>T2</span>
                            </label>
                            
                            <input type="radio" class="btn-check" name="trim" id="tr3" value="3" autocomplete="off">
                            <label class="btn btn-outline-success px-3 py-2 d-flex align-items-center" for="tr3">
                              <i class="bi bi-3-circle me-2 d-none d-sm-inline"></i>
                              <span>T3</span>
                            </label>
                            
                            <input type="radio" class="btn-check" name="trim" id="tr4" value="4" autocomplete="off">
                            <label class="btn btn-outline-success px-3 py-2 rounded-end-pill d-flex align-items-center" for="tr4">
                              <i class="bi bi-4-circle me-2 d-none d-sm-inline"></i>
                              <span>T4</span>
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <style>
                /* Effet de survol amélioré */
                .btn-outline-success:hover {
                  background-color: rgba(0, 100, 0, 0.1);
                  transform: translateY(-1px);
                }
                
                /* Animation de sélection */
                .btn-check:checked + .btn-outline-success {
                  background-color: var(--bs-success);
                  color: white;
                  box-shadow: 0 2px 8px rgba(0, 100, 0, 0.2);
                }
                
                /* Transition fluide */
                .btn, .card {
                  transition: all 0.3s ease;
                }
                
                /* Effet de profondeur */
                .shadow-sm {
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
                }
                
                /* Arrondis modernes */
                .rounded-4 {
                  border-radius: 12px !important;
                }
              </style>
              <div class="row g-4">
                <!-- Colonne Top Performances -->
                <div class="col-xl-6 col-md-6">
                  <div class="section-header bg-success bg-opacity-10 p-3 rounded-3 mb-3 d-flex align-items-center">
                    <i class="fas fa-trophy text-success fs-4 me-3"></i>
                    <div>
                      <h3 class="h5 mb-0 text-success fw-bold">Top Performances</h3>
                      <p class="small text-muted mb-0">Les projets les plus performants ce trimestre</p>
                    </div>
                  </div>
                  
                  <!-- Carte 1_1 -->
                  <div class="card border-0 shadow-sm mb-3 hover-scale" style="border-radius: 10px; transition: all 0.3s ease;">
                    <div class="card-header py-2 px-3 text-white" style="border-radius: 10px 10px 0 0; background: linear-gradient(135deg, #004600, #007a00);">
                      <div class="d-flex justify-content-between align-items-center gap-2">
                        <div class="dropdown w-40">
                          <button class="btn btn-outline-light dropdown-toggle d-flex justify-content-between align-items-center w-100"  id="selectionL1" style="background: rgba(255,255,255,0.92); border: none; color: black;" type="button" data-bs-toggle="dropdown">
                            <span class="text-wrap me-2" style="white-space: normal; text-align: left;">Sélectionnez un projet</span>
                          </button>
                          <ul class="dropdown-menu" id="listDeroulante1">
                          </ul>
                        </div>
                        <div class="dropdown w-60">
                          <button class="btn btn-outline-light dropdown-toggle d-flex justify-content-between align-items-center w-100" id="selectionL2" style="background: rgba(255,255,255,0.92); border: none; color: black;" type="button" data-bs-toggle="dropdown">
                            <span class="text-wrap me-2" style="white-space: normal; text-align: left;">Composante</span>
                          </button class="text-wrap me-2" style="white-space: normal; text-align: left;">
                          <ul class="dropdown-menu" id="listDeroulante2">
                          </ul>
                        </div>
                      </div>
                    </div>

                    <div class="card-body p-3">
                      <div class="row text-center g-2">
                        <div class="col-4">
                          <div class="p-2 bg-light bg-opacity-50 rounded-3 h-100">
                            <small class="text-muted d-block">Cible trimestre T</small>
                            <div class="fw-bold text-success mb-2 fs-5"><span id="prev_tn_total_0">-</span>%</div>
                            <!--<div class="progress" style="height: 6px;">
                              <div class="progress-bar bg-success progress-bar-striped" style="width: 78%"></div>
                            </div>-->
                          </div>
                        </div>
                        <div class="col-4">
                          <div class="p-2 bg-light bg-opacity-50 rounded-3 h-100">
                            <small class="text-muted d-block">Trimestre précédent</small>
                            <div class="fw-bold text-success mb-2 fs-5"><span id="realise_tn_1_total_0">-</span>%</div>
                          </div>
                        </div>
                        <div class="col-4">
                          <div class="p-2 bg-light bg-opacity-50 rounded-3 h-100">
                            <small class="text-muted d-block">Trimestre actuel</small>
                            <div class="fw-bold text-success mb-2 fs-5"><span id="realise_tn_total_0">-</span>%</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="card-footer bg-white py-2 px-3" style="border-radius: 0 0 10px 10px;">
                      <div class="alert alert-success alert-light mb-0 py-1 px-2 d-flex align-items-center">
                        
                        <div>
                        <span class="fw-semibold">Facteurs explicatifs:</span>
                        <small class="small" id="facteurs_explication_value_0"> </small>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Carte 1_2 -->
                  <div class="card border-0 shadow-sm mb-3 hover-scale" style="border-radius: 10px; transition: all 0.3s ease;">
                    <div class="card-header py-2 px-3 text-white" style="border-radius: 10px 10px 0 0; background: linear-gradient(135deg, #004600, #007a00);">
                      <div class="d-flex justify-content-between align-items-center gap-2">
                        <div class="dropdown w-40">
                          <button class="btn btn-outline-light dropdown-toggle d-flex justify-content-between align-items-center w-100"  id="selectionL1_1" style="background: rgba(255,255,255,0.92); border: none; color: black;" type="button" data-bs-toggle="dropdown">
                            <span class="text-wrap me-2" style="white-space: normal; text-align: left;">Sélectionnez un projet</span>
                          </button>
                          <ul class="dropdown-menu" id="listDeroulante1_1">
                          </ul>
                        </div>
                        <div class="dropdown w-60">
                          <button class="btn btn-outline-light dropdown-toggle d-flex justify-content-between align-items-center w-100" id="selectionL2_1" style="background: rgba(255,255,255,0.92); border: none; color: black;" type="button" data-bs-toggle="dropdown">
                            <span class="text-wrap me-2" style="white-space: normal; text-align: left;">Composante</span>
                          </button>
                          <ul class="dropdown-menu" id="listDeroulante2_1">
                          </ul>
                        </div>
                      </div>
                    </div>

                    <div class="card-body p-3">
                      <div class="row text-center g-2">
                        <div class="col-4">
                          <div class="p-2 bg-light bg-opacity-50 rounded-3 h-100">
                            <small class="text-muted d-block">Cible trimestre T</small>
                            <div class="fw-bold text-success mb-2 fs-5"><span id="prev_tn_total_1">-</span>%</div>
                          </div>
                        </div>
                        <div class="col-4">
                          <div class="p-2 bg-light bg-opacity-50 rounded-3 h-100">
                            <small class="text-muted d-block">Trimestre précédent</small>
                            <div class="fw-bold text-success mb-2 fs-5"><span id="realise_tn_1_total_1">-</span>%</div>
                          </div>
                        </div>
                        <div class="col-4">
                          <div class="p-2 bg-light bg-opacity-50 rounded-3 h-100">
                            <small class="text-muted d-block">Trimestre actuel</small>
                            <div class="fw-bold text-success mb-2 fs-5"><span id="realise_tn_total_1">-</span>%</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="card-footer bg-white py-2 px-3" style="border-radius: 0 0 10px 10px;">
                      <div class="alert alert-success alert-light mb-0 py-1 px-2 d-flex align-items-center">
                        
                        <div>
                        <span class="fw-semibold">Facteurs explicatifs:</span>
                        <small class="small" id="facteurs_explication_value_1"> </small>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Carte 1_3 -->
                  <div class="card border-0 shadow-sm mb-3 hover-scale" style="border-radius: 10px; transition: all 0.3s ease;">
                    <div class="card-header py-2 px-3 text-white" style="border-radius: 10px 10px 0 0; background: linear-gradient(135deg, #004600, #007a00);">
                      <div class="d-flex justify-content-between align-items-center gap-2">
                        <div class="dropdown w-40">
                          <button class="btn btn-outline-light dropdown-toggle d-flex justify-content-between align-items-center w-100"  id="selectionL1_2" style="background: rgba(255,255,255,0.92); border: none; color: black;" type="button" data-bs-toggle="dropdown">
                            <span class="text-wrap me-2" style="white-space: normal; text-align: left;">Sélectionnez un projet</span>
                          </button>
                          <ul class="dropdown-menu" id="listDeroulante1_2">
                          </ul>
                        </div>
                        <div class="dropdown w-60">
                          <button class="btn btn-outline-light dropdown-toggle d-flex justify-content-between align-items-center w-100" id="selectionL2_2" style="background: rgba(255,255,255,0.92); border: none; color: black;" type="button" data-bs-toggle="dropdown">
                            <span class="text-wrap me-2" style="white-space: normal; text-align: left;">Composante</span>
                          </button>
                          <ul class="dropdown-menu" id="listDeroulante2_2">
                          </ul>
                        </div>
                      </div>
                    </div>

                    <div class="card-body p-3">
                      <div class="row text-center g-2">
                        <div class="col-4">
                          <div class="p-2 bg-light bg-opacity-50 rounded-3 h-100">
                            <small class="text-muted d-block">Cible trimestre T</small>
                            <div class="fw-bold text-success mb-2 fs-5"><span id="prev_tn_total_2">-</span>%</div>
                          </div>
                        </div>
                        <div class="col-4">
                          <div class="p-2 bg-light bg-opacity-50 rounded-3 h-100">
                            <small class="text-muted d-block">Trimestre précédent</small>
                            <div class="fw-bold text-success mb-2 fs-5"><span id="realise_tn_1_total_2">-</span>%</div>
                          </div>
                        </div>
                        <div class="col-4">
                          <div class="p-2 bg-light bg-opacity-50 rounded-3 h-100">
                            <small class="text-muted d-block">Trimestre actuel</small>
                            <div class="fw-bold text-success mb-2 fs-5"><span id="realise_tn_total_2">-</span>%</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="card-footer bg-white py-2 px-3" style="border-radius: 0 0 10px 10px;">
                      <div class="alert alert-success alert-light mb-0 py-1 px-2 d-flex align-items-center">
                        
                        <div>
                        <span class="fw-semibold">Facteurs explicatifs:</span>
                        <small class="small" id="facteurs_explication_value_2"> </small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Colonne À Surveiller -->
                <div class="col-xl-6 col-md-6">
                  <div class="section-header bg-danger bg-opacity-10 p-3 rounded-3 mb-3 d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle text-danger fs-4 me-3"></i>
                    <div>
                      <h3 class="h5 mb-0 text-danger fw-bold">À Surveiller</h3>
                      <p class="small text-muted mb-0">Projets nécessitant une attention particulière</p>
                    </div>
                  </div>
                  
                  <!-- Carte 2_1 -->
                  <div class="card border-0 shadow-sm mb-3 hover-scale" style="border-radius: 10px; transition: all 0.3s ease;">
                    <div class="card-header py-2 px-3 text-white" style="border-radius: 10px 10px 0 0; background: linear-gradient(135deg, #8b0000, #c00000);">
                      <div class="d-flex justify-content-between align-items-center gap-2">
                        <div class="dropdown w-40">
                          <button class="btn btn-outline-light dropdown-toggle d-flex justify-content-between align-items-center w-100"  id="selectionL1_3" style="background: rgba(255,255,255,0.92); border: none; color: black;" type="button" data-bs-toggle="dropdown">
                            <span class="text-wrap me-2" style="white-space: normal; text-align: left;">Sélectionnez un projet</span>
                          </button>
                          <ul class="dropdown-menu" id="listDeroulante1_3">
                          </ul>
                        </div>
                        <div class="dropdown w-60">
                          <button class="btn btn-outline-light dropdown-toggle d-flex justify-content-between align-items-center w-100" id="selectionL2_3" style="background: rgba(255, 255, 255, 0.92); border: none; color: black;" type="button" data-bs-toggle="dropdown">
                            <span class="text-wrap me-2" style="white-space: normal; text-align: left;">Composante</span>
                          </button>
                          <ul class="dropdown-menu" id="listDeroulante2_3">
                          </ul>
                        </div>
                      </div>
                    </div>

                    <div class="card-body p-3">
                      <div class="row text-center g-2">
                        <div class="col-4">
                          <div class="p-2 bg-light bg-opacity-50 rounded-3 h-100">
                            <small class="text-muted d-block">Cible trimestre T</small>
                            <div class="fw-bold text-success mb-2 fs-5"><span id="prev_tn_total_3">-</span>%</div>
                          </div>
                        </div>
                        <div class="col-4">
                          <div class="p-2 bg-light bg-opacity-50 rounded-3 h-100">
                            <small class="text-muted d-block">Trimestre précédent</small>
                            <div class="fw-bold text-success mb-2 fs-5"><span id="realise_tn_1_total_3">-</span>%</div>
                          </div>
                        </div>
                        <div class="col-4">
                          <div class="p-2 bg-light bg-opacity-50 rounded-3 h-100">
                            <small class="text-muted d-block">Trimestre actuel</small>
                            <div class="fw-bold text-success mb-2 fs-5"><span id="realise_tn_total_3">-</span>%</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="card-footer bg-white py-2 px-3" style="border-radius: 0 0 10px 10px;">
                      <div class="alert alert-danger alert-light mb-0 py-1 px-2 d-flex align-items-center">
                        
                        <div>
                        <span class="fw-semibold">Facteurs explicatifs:</span>
                        <small class="small" id="facteurs_explication_value_3"> </small>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Carte 2_2 -->
                  <div class="card border-0 shadow-sm mb-3 hover-scale" style="border-radius: 10px; transition: all 0.3s ease;">
                    <div class="card-header py-2 px-3 text-white" style="border-radius: 10px 10px 0 0; background: linear-gradient(135deg, #8b0000, #c00000);">
                      <div class="d-flex justify-content-between align-items-center gap-2">
                        <div class="dropdown w-40">
                          <button class="btn btn-outline-light dropdown-toggle d-flex justify-content-between align-items-center w-100"  id="selectionL1_4" style="background: rgba(255,255,255,0.92); border: none; color: black;" type="button" data-bs-toggle="dropdown">
                            <span class="text-wrap me-2" style="white-space: normal; text-align: left;">Sélectionnez un projet</span>
                          </button>
                          <ul class="dropdown-menu" id="listDeroulante1_4">
                          </ul>
                        </div>
                        <div class="dropdown w-60">
                          <button class="btn btn-outline-light dropdown-toggle d-flex justify-content-between align-items-center w-100" id="selectionL2_4" style="background: rgba(255,255,255,0.92); border: none; color: black;" type="button" data-bs-toggle="dropdown">
                            <span class="text-wrap me-2" style="white-space: normal; text-align: left;">Composante</span>
                          </button>
                          <ul class="dropdown-menu" id="listDeroulante2_4">
                          </ul>
                        </div>
                      </div>
                    </div>

                    <div class="card-body p-3">
                      <div class="row text-center g-2">
                        <div class="col-4">
                          <div class="p-2 bg-light bg-opacity-50 rounded-3 h-100">
                            <small class="text-muted d-block">Cible trimestre T</small>
                            <div class="fw-bold text-success mb-2 fs-5"><span id="prev_tn_total_4">-</span>%</div>
                          </div>
                        </div>
                        <div class="col-4">
                          <div class="p-2 bg-light bg-opacity-50 rounded-3 h-100">
                            <small class="text-muted d-block">Trimestre précédent</small>
                            <div class="fw-bold text-success mb-2 fs-5"><span id="realise_tn_1_total_4">-</span>%</div>
                          </div>
                        </div>
                        <div class="col-4">
                          <div class="p-2 bg-light bg-opacity-50 rounded-3 h-100">
                            <small class="text-muted d-block">Trimestre actuel</small>
                            <div class="fw-bold text-success mb-2 fs-5"><span id="realise_tn_total_4">-</span>%</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="card-footer bg-white py-2 px-3" style="border-radius: 0 0 10px 10px;">
                      <div class="alert alert-danger alert-light mb-0 py-1 px-2 d-flex align-items-center">
                        
                        <div>
                        <span class="fw-semibold">Facteurs explicatifs:</span>
                        <small class="small" id="facteurs_explication_value_4"> </small>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Carte 2_3 -->
                  <div class="card border-0 shadow-sm mb-3 hover-scale" style="border-radius: 10px; transition: all 0.3s ease;">
                    <div class="card-header py-2 px-3 text-white" style="border-radius: 10px 10px 0 0; background: linear-gradient(135deg, #8b0000, #c00000);">
                      <div class="d-flex justify-content-between align-items-center gap-2">
                        <div class="dropdown w-40">
                          <button class="btn btn-outline-light dropdown-toggle d-flex justify-content-between align-items-center w-100"  id="selectionL1_5" style="background: rgba(255,255,255,0.92); border: none; color: black;" type="button" data-bs-toggle="dropdown">
                            <span class="text-wrap me-2" style="white-space: normal; text-align: left;">Sélectionnez un projet</span>
                          </button>
                          <ul class="dropdown-menu" id="listDeroulante1_5">
                          </ul>
                        </div>
                        <div class="dropdown w-60">
                          <button class="btn btn-outline-light dropdown-toggle d-flex justify-content-between align-items-center w-100" id="selectionL2_5" style="background: rgba(255,255,255,0.92); border: none; color: black;" type="button" data-bs-toggle="dropdown">
                            <span class="text-wrap me-2" style="white-space: normal; text-align: left;">Composante</span>
                          </button>
                          <ul class="dropdown-menu" id="listDeroulante2_5">
                          </ul>
                        </div>
                      </div>
                    </div>

                    <div class="card-body p-3">
                      <div class="row text-center g-2">
                        <div class="col-4">
                          <div class="p-2 bg-light bg-opacity-50 rounded-3 h-100">
                            <small class="text-muted d-block">Cible trimestre T</small>
                            <div class="fw-bold text-success mb-2 fs-5"><span id="prev_tn_total_5">-</span>%</div>
                          </div>
                        </div>
                        <div class="col-4">
                          <div class="p-2 bg-light bg-opacity-50 rounded-3 h-100">
                            <small class="text-muted d-block">Trimestre précédent</small>
                            <div class="fw-bold text-success mb-2 fs-5"><span id="realise_tn_1_total_5">-</span>%</div>
                          </div>
                        </div>
                        <div class="col-4">
                          <div class="p-2 bg-light bg-opacity-50 rounded-3 h-100">
                            <small class="text-muted d-block">Trimestre actuel</small>
                            <div class="fw-bold text-success mb-2 fs-5"><span id="realise_tn_total_5">-</span>%</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="card-footer bg-white py-2 px-3" style="border-radius: 0 0 10px 10px;">
                      <div class="alert alert-danger alert-light mb-0 py-1 px-2 d-flex align-items-center">
                        
                        <div>
                        <span class="fw-semibold">Facteurs explicatifs:</span>
                        <small class="small" id="facteurs_explication_value_5"> </small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- 4eme ligne-->
      <div class="container-fluid py-4">
        <!-- Filtres hiérarchiques - Version améliorée -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header" style="background-color: #004600;">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-white">Gestion des problèmes</h5>
                        </div>
                    </div>
                    <div class="card-body pt-3">
                        <div class="row g-3">
                            <!-- Niveau 1 -->
                            <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                                <label class="form-label fw-bold small text-muted">Niveau 1</label>
                                <div class="dropdown">
                                    <button class="btn btn-light dropdown-toggle w-100 text-start d-flex justify-content-between align-items-center py-2 px-3 border" 
                                            type="button" id="PdropdownL1Button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <span id="PselectedL1" class="text-truncate">Tous</span>
                                    </button>
                                    <ul class="dropdown-menu w-100" aria-labelledby="PdropdownL1Button" id="l1DropdownMenu">
                                        <li><a class="dropdown-item py-2 active" href="#"  onclick="PupdateL1Filter('all', 'Tous'); return false;" style="white-space: normal;">Tous</a></li>
                                        <li><a class="dropdown-item py-2" href="#" onclick="PupdateL1Filter('axe', 'Axe'); return false;"  style="white-space: normal;">Axe</a></li>
                                        <li><a class="dropdown-item py-2" href="#" onclick="PupdateL1Filter('portefeuille', 'Portefeuille'); return false;" style="white-space: normal;">Portefeuille</a></li>
                                        <li><a class="dropdown-item py-2" href="#" onclick="PupdateL1Filter('ministere', 'Ministère responsable'); return false;" style="white-space: normal;">Ministère responsable</a></li>
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- Niveau 2 -->
                            <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                                <label class="form-label fw-bold small text-muted">Niveau 2</label>
                                <div class="dropdown">
                                    <button class="btn btn-light dropdown-toggle w-100 text-start d-flex justify-content-between align-items-center py-2 px-3 border" 
                                            type="button" id="PdropdownL2Button" data-bs-toggle="dropdown" aria-expanded="false" disabled>
                                        <span id="PselectedL2" class="text-truncate">-</span>
                                    </button>
                                    <ul class="dropdown-menu w-100" aria-labelledby="PdropdownL2Button" id="Pl2DropdownMenu">
                                        <li><a class="dropdown-item py-2 disabled" href="#">Sélectionnez Niveau 1</a></li>
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- Programme -->
                            <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                                <label class="form-label fw-bold small text-muted">Programme</label>
                                <div class="dropdown">
                                    <button class="btn btn-light dropdown-toggle w-100 text-start d-flex justify-content-between align-items-center py-2 px-3 border" 
                                            type="button" id="PdropdownL3Button" data-bs-toggle="dropdown" aria-expanded="false" disabled>
                                        <span id="PselectedL3" class="text-wrap me-2" style="white-space: normal; text-align: left;">-</span>
                                    </button>
                                    <ul class="dropdown-menu w-100" aria-labelledby="PdropdownL3Button" id="Pl3DropdownMenu">
                                        <li><a class="dropdown-item py-2 disabled" href="#">Sélectionnez Niveau 2</a></li>
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- Projet -->
                            <div class="col-xl-3 col-lg-3 col-md-4 col-sm-6">
                                <label class="form-label fw-bold small text-muted">Projet</label>
                                <div class="dropdown">
                                    <button class="btn btn-light dropdown-toggle w-100 text-start d-flex justify-content-between align-items-center py-2 px-3 border" 
                                            type="button" id="PdropdownL4Button" data-bs-toggle="dropdown" aria-expanded="false" disabled>
                                        <span id="PselectedL4" class="text-wrap me-2" style="white-space: normal; text-align: left;">-</span>
                                    </button>
                                    <ul class="dropdown-menu w-100" aria-labelledby="PdropdownL4Button" id="Pl4DropdownMenu">
                                        <li><a class="dropdown-item py-2 disabled" href="#">Sélectionnez Programme</a></li>
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- Composante -->
                            <div class="col-xl-3 col-lg-3 col-md-4 col-sm-6">
                                <label class="form-label fw-bold small text-muted">Composante</label>
                                <div class="dropdown">
                                    <button class="btn btn-light dropdown-toggle w-100 text-start d-flex justify-content-between align-items-center py-2 px-3 border" 
                                            type="button" id="PdropdownL5Button" data-bs-toggle="dropdown" aria-expanded="false" disabled>
                                        <span id="PselectedL5" class="text-wrap me-2" style="white-space: normal; text-align: left;">-</span>
                                    </button>
                                    <ul class="dropdown-menu w-100" aria-labelledby="PdropdownL5Button" id="Pl5DropdownMenu">
                                        <li><a class="dropdown-item py-2 disabled" href="#">Sélectionnez Projet</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conteneur des problèmes -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-0">
                        <div id="problemes-container" class="p-4">
                            <div class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
                                <div class="text-center">
                                    <i class="fas fa-info-circle fa-2x text-muted mb-3"></i>
                                    <p class="text-muted">Sélectionnez des filtres pour afficher les problèmes</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Réinitialiser la vue de la carte
            document.getElementById('reset-map-view')?.addEventListener('click', function() {
                if (window.map) {
                    window.map.setView([14.4974, -14.4524], 7);
                }
            });

            // Variables pour les dropdowns
          const PdropdownL1Button = document.getElementById('PdropdownL1Button');
          const PdropdownL2Button = document.getElementById('PdropdownL2Button');
          const PdropdownL3Button = document.getElementById('PdropdownL3Button');
          const PdropdownL4Button = document.getElementById('PdropdownL4Button');
          const PdropdownL5Button = document.getElementById('PdropdownL5Button');

          const Pl2DropdownMenu = document.getElementById('Pl2DropdownMenu');
          const Pl3DropdownMenu = document.getElementById('Pl3DropdownMenu');
          const Pl4DropdownMenu = document.getElementById('Pl4DropdownMenu');
          const Pl5DropdownMenu = document.getElementById('Pl5DropdownMenu');

          // Variables pour stocker les valeurs sélectionnées
          let l1Value = 'all';
          let l2Value = null;
          let l3Value = null;
          let l4Value = null;
          let l5Value = null;

          // Fonction pour mettre à jour le filtre L1
          window.PupdateL1Filter = function(value, displayText) {
            l1Value = value;
            document.getElementById('PselectedL1').textContent = displayText;
            PresetFilters([PdropdownL2Button, PdropdownL3Button, PdropdownL4Button, PdropdownL5Button]);

            if (value !== 'all') {
                fetchL2Options(value);
            } else {
                fetchGlobalStats();
            }
          };

          // Fonction pour mettre à jour le filtre L2
          window.PupdateL2Filter = function(value, displayText) {
            l2Value = value;
            document.getElementById('PselectedL2').textContent = displayText;
            PresetFilters([PdropdownL3Button, PdropdownL4Button, PdropdownL5Button]);

            if (value) {
                fetchL3Options(l1Value, value);
                fetchStats(l1Value, value);
            }
          };

          // Fonction pour mettre à jour le filtre L3
          window.PupdateL3Filter = function(value, displayText) {
            l3Value = value;
            document.getElementById('PselectedL3').textContent = displayText;
            PresetFilters([PdropdownL4Button, PdropdownL5Button]);

            if (value) {
                fetchL4Options(value);
            }
          };
    
          // Fonction pour mettre à jour le filtre L4
          window.PupdateL4Filter = function(value, displayText) {
              l4Value = value;
              document.getElementById('PselectedL4').textContent = displayText;
              PresetFilters([PdropdownL5Button]);
              
              if (value) {
                  fetchL5Options(value);
              }
          };
          
          // Fonction pour mettre à jour le filtre L5
          window.PupdateL5Filter = function(value, displayText) {
              l5Value = value;
              document.getElementById('PselectedL5').textContent = displayText;
              
              if (value) {
                  fetchComposanteDetails(value);
                  fetchProblemes(value);
              }
          };
          
          // Fonctions utilitaires
          function PresetFilters(filters) {
              filters.forEach(filter => {
                  if (!filter) return; // Vérification si l'élément existe
                  
                  filter.disabled = true;
                  const spanId = filter.id.replace('dropdown', 'selected').replace('Button', '');
                  const spanElement = document.getElementById(spanId);
                  if (spanElement) {
                      spanElement.textContent = 'Sélectionnez d\'abord le niveau précédent';
                  }
                  
                  const menuId = filter.id.replace('Button', 'Menu');
                  const menu = document.getElementById(menuId);
                  if (menu) {
                      menu.innerHTML = '<li><a class="dropdown-item" href="#">Sélectionnez d\'abord le niveau précédent</a></li>';
                  }
              });
          }
          
          function fetchL2Options(l1Value) {
              const url = `/api/filters/l2/?l1=${l1Value}`;
              
              fetch(url)
                  .then(response => response.json())
                  .then(data => {
                      PdropdownL2Button.disabled = false;
                      document.getElementById('PselectedL2').textContent = 'Sélectionnez une option';
                      
                      if (Pl2DropdownMenu) {
                          Pl2DropdownMenu.innerHTML = '';
                          data.options.forEach(option => {
                              const li = document.createElement('li');
                              const a = document.createElement('a');
                              a.className = 'dropdown-item';
                              a.href = '#';
                              a.textContent = option.name;
                              a.onclick = function() {
                                  PupdateL2Filter(option.id, option.name);
                                  return false;
                              };
                              li.appendChild(a);
                              Pl2DropdownMenu.appendChild(li);
                          });
                      }
                  })
                  .catch(error => {
                      console.error('Error fetching L2 options:', error);
                  });
          }
          
          function fetchL3Options(l1Value, l2Value) {
              const url = `/api/filters/l3/?l1=${l1Value}&l2=${l2Value}`;
              
              fetch(url)
                  .then(response => response.json())
                  .then(data => {
                      PdropdownL3Button.disabled = false;
                      document.getElementById('PselectedL3').textContent = 'Sélectionnez un programme';
                      
                      if (Pl3DropdownMenu) {
                          Pl3DropdownMenu.innerHTML = '';
                          data.options.forEach(option => {
                              const li = document.createElement('li');
                              const a = document.createElement('a');
                              a.className = 'dropdown-item';
                              a.href = '#';
                              a.textContent = option.name;
                              a.onclick = function() {
                                  PupdateL3Filter(option.id, option.name);
                                  return false;
                              };
                              li.appendChild(a);
                              Pl3DropdownMenu.appendChild(li);
                          });
                      }
                  })
                  .catch(error => {
                      console.error('Error fetching L3 options:', error);
                  });
          }
    
          function fetchL4Options(l3Value) {
              const url = `/api/filters/l4/?l3=${l3Value}`;
              
              fetch(url)
                  .then(response => response.json())
                  .then(data => {
                      PdropdownL4Button.disabled = false;
                      document.getElementById('PselectedL4').textContent = 'Sélectionnez un projet';
                      
                      if (Pl4DropdownMenu) {
                          Pl4DropdownMenu.innerHTML = '';
                          data.options.forEach(option => {
                              const li = document.createElement('li');
                              const a = document.createElement('a');
                              a.className = 'dropdown-item';
                              a.href = '#';
                              a.textContent = option.name;
                              a.onclick = function() {
                                  PupdateL4Filter(option.id, option.name);
                                  return false;
                              };
                              li.appendChild(a);
                              Pl4DropdownMenu.appendChild(li);
                          });
                      }
                  })
                  .catch(error => {
                      console.error('Error fetching L4 options:', error);
                  });
          }
          
          function fetchL5Options(l4Value) {
              const url = `/api/filters/l5/?l4=${l4Value}`;
              
              fetch(url)
                  .then(response => response.json())
                  .then(data => {
                      PdropdownL5Button.disabled = false;
                      document.getElementById('PselectedL5').textContent = 'Sélectionnez une composante';
                      
                      if (Pl5DropdownMenu) {
                          Pl5DropdownMenu.innerHTML = '';
                          data.options.forEach(option => {
                              const li = document.createElement('li');
                              const a = document.createElement('a');
                              a.className = 'dropdown-item';
                              a.href = '#';
                              a.textContent = option.name;
                              a.onclick = function() {
                                  PupdateL5Filter(option.id, option.name);
                                  return false;
                              };
                              li.appendChild(a);
                              Pl5DropdownMenu.appendChild(li);
                          });
                      }
                  })
                  .catch(error => {
                      console.error('Error fetching L5 options:', error);
                  });
          }
          
          // Les fonctions fetchStats, fetchGlobalStats, fetchComposanteDetails et fetchProblemes restent inchangées
          function fetchStats(l1Value, l2Value) {
              const url = `/api/stats/?l1=${l1Value}&l2=${l2Value}`;
              
              fetch(url)
                  .then(response => response.json())
                  .then(data => {
                      const statsContainer = document.getElementById('stats-container');
                      if (statsContainer) {
                          statsContainer.innerHTML = `
                              <div class="row">
                                  <div class="col-md-3">
                                      <div class="card bg-light">
                                          <div class="card-body">
                                              <h5 class="card-title">Programmes</h5>
                                              <p class="card-text display-4">${data.program_count}</p>
                                          </div>
                                      </div>
                                  </div>
                                  <div class="col-md-3">
                                      <div class="card bg-light">
                                          <div class="card-body">
                                              <h5 class="card-title">Projets</h5>
                                              <p class="card-text display-4">${data.project_count}</p>
                                          </div>
                                      </div>
                                  </div>
                                  <div class="col-md-3">
                                      <div class="card bg-light">
                                          <div class="card-body">
                                              <h5 class="card-title">Projets démarrés</h5>
                                              <p class="card-text display-4">${data.started_project_count}</p>
                                          </div>
                                      </div>
                                  </div>
                                  <div class="col-md-3">
                                      <div class="card bg-light">
                                          <div class="card-body">
                                              <h5 class="card-title">Responsable</h5>
                                              <p class="card-text">${data.responsable || 'N/A'}</p>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          `;
                      }
                  })
                  .catch(error => {
                      console.error('Error fetching stats:', error);
                  });
          }
          
          function fetchGlobalStats() {
              const url = `/api/stats/global/`;
              
              fetch(url)
                  .then(response => response.json())
                  .then(data => {
                      const statsContainer = document.getElementById('stats-container');
                      if (statsContainer) {
                          statsContainer.innerHTML = `
                              <div class="row">
                                  <div class="col-md-3">
                                      <div class="card bg-light">
                                          <div class="card-body">
                                              <h5 class="card-title">Axes</h5>
                                              <p class="card-text display-4">${data.axe_count}</p>
                                          </div>
                                      </div>
                                  </div>
                                  <div class="col-md-3">
                                      <div class="card bg-light">
                                          <div class="card-body">
                                              <h5 class="card-title">Portefeuilles</h5>
                                              <p class="card-text display-4">${data.portefeuille_count}</p>
                                          </div>
                                      </div>
                                  </div>
                                  <div class="col-md-3">
                                      <div class="card bg-light">
                                          <div class="card-body">
                                              <h5 class="card-title">Programmes</h5>
                                              <p class="card-text display-4">${data.program_count}</p>
                                          </div>
                                      </div>
                                  </div>
                                  <div class="col-md-3">
                                      <div class="card bg-light">
                                          <div class="card-body">
                                              <h5 class="card-title">Projets</h5>
                                              <p class="card-text display-4">${data.project_count}</p>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          `;
                      }
                  })
                  .catch(error => {
                      console.error('Error fetching global stats:', error);
                  });
          }
          
          function fetchComposanteDetails(composanteId) {
              const url = `/api/composantes/${composanteId}/`;
              
              fetch(url)
                  .then(response => response.json())
                  .then(data => {
                      const detailsContainer = document.getElementById('composante-details');
                      if (detailsContainer) {
                          detailsContainer.innerHTML = `
                              <div class="row">
                                  <div class="col-md-6">
                                      <h5>${data.nom}</h5>
                                      <p><strong>Localisation:</strong> ${data.localisation}</p>
                                      <p><strong>Tutelle:</strong> ${data.tutelle}</p>
                                      <p><strong>Statut:</strong> ${data.statut}</p>
                                  </div>
                                  <div class="col-md-6">
                                      <div class="card">
                                          <div class="card-header">
                                              <h6>Financement</h6>
                                          </div>
                                          <div class="card-body">
                                              <p><strong>Cible fin d'année:</strong> ${data.cible_fin_annee}%</p>
                                              <p><strong>Décaissement:</strong> ${data.taux_decaissement}%</p>
                                              <div class="progress mt-2">
                                                  <div class="progress-bar" role="progressbar" style="width: ${data.taux_decaissement}%" 
                                                      aria-valuenow="${data.taux_decaissement}" aria-valuemin="0" aria-valuemax="100"></div>
                                              </div>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          `;
                      }
                  })
                  .catch(error => {
                      console.error('Error fetching composante details:', error);
                  });
          }
    
   
            
          function fetchProblemes(composanteId) {
              const url = `/api/problemes/?composante=${composanteId}`;
              
              fetch(url)
                  .then(response => {
                      if (!response.ok) throw new Error(`Erreur HTTP! statut: ${response.status}`);
                      return response.json();
                  })
                  .then(data => {
                      const container = document.getElementById('problemes-container');
                      
                      if (!container) {
                          console.error('Element container introuvable');
                          return;
                      }
                      
                      if (data.length === 0) {
                          container.innerHTML = '<p class="text-muted">Aucun problème associé à cette composante</p>';
                          return;
                      }

                      // Calcul des statistiques
                      const stats = {
                          total: data.length,
                          clos: data.filter(p => p.statut_solution === 'Cloturé').length,
                          enCours: data.filter(p => p.statut_solution === 'En cours').length,
                          nonTraite: data.filter(p => !p.statut_solution || p.statut_solution === 'Non traité').length,
                          delaiMoyen: calculerDelaiMoyen(data)
                      };

                      const typologieData = data.reduce((acc, probleme) => {
                          const typologie = probleme.typologie || 'Non spécifié';
                          acc[typologie] = (acc[typologie] || 0) + 1;
                          return acc;
                      }, {});

                      const criticiteData = data.reduce((acc, probleme) => {
                          const criticite = probleme.criticite || 'Non évaluée';
                          acc[criticite] = (acc[criticite] || 0) + 1;
                          return acc;
                      }, {});

                      // Construction du HTML avec design sobre
                      container.innerHTML = `
                          <!-- Statistiques simplifiées -->
                          <div class="row mb-4 g-3">
                              <div class="col-md-3">
                                  <div class="card border-0 shadow-sm">
                                      <div class="card-body text-center">
                                          <h6 class="text-muted mb-2">Total problèmes</h6>
                                          <h3 class="fw-bold" style="color: #004600">${stats.total}</h3>
                                      </div>
                                  </div>
                              </div>
                              <div class="col-md-3">
                                  <div class="card border-0 shadow-sm">
                                      <div class="card-body text-center">
                                          <h6 class="text-muted mb-2">Clôturés</h6>
                                          <h3 class="fw-bold" style="color: #006600">${stats.clos} <small class="text-muted">(${Math.round((stats.clos/stats.total)*100)}%)</small></h3>
                                      </div>
                                  </div>
                              </div>
                              <div class="col-md-3">
                                  <div class="card border-0 shadow-sm">
                                      <div class="card-body text-center">
                                          <h6 class="text-muted mb-2">En cours</h6>
                                          <h3 class="fw-bold" style="color: #003300">${stats.enCours}</h3>
                                      </div>
                                  </div>
                              </div>
                              <div class="col-md-3">
                                  <div class="card border-0 shadow-sm">
                                      <div class="card-body text-center">
                                          <h6 class="text-muted mb-2">Délai moyen</h6>
                                          <h3 class="fw-bold" style="color: #004600">${stats.delaiMoyen ? stats.delaiMoyen + ' jours' : 'N/A'}</h3>
                                      </div>
                                  </div>
                              </div>
                          </div>

                          <!-- Graphiques compacts -->
                          <div class="row g-3">
                              <div class="col-md-6">
                                  <div class="card border-0 shadow-sm h-100">
                                      <div class="card-header bg-white border-0">
                                          <h6 class="mb-0">Répartition par typologie</h6>
                                      </div>
                                      <div class="card-body p-3">
                                          <div class="chart-container" style="height: 250px">
                                              <canvas id="typologieChart"></canvas>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                              
                              <div class="col-md-6">
                                  <div class="card border-0 shadow-sm h-100">
                                      <div class="card-header bg-white border-0">
                                          <h6 class="mb-0">Répartition par criticité</h6>
                                      </div>
                                      <div class="card-body p-3">
                                          <div class="chart-container" style="height: 250px">
                                              <canvas id="criticiteChart"></canvas>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          </div>
                          
                          <!-- Tableau -->
                          <div class="row mt-4">
                              <div class="col-12">
                                  <div class="card border-0 shadow-sm">
                                      <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                                          <h6 class="mb-0">Liste des problèmes</h6>
                                          <div>
                                              <span class="badge rounded-pill bg-success me-1">Clôturé: ${stats.clos}</span>
                                              <span class="badge rounded-pill bg-warning me-1">En cours: ${stats.enCours}</span>
                                              <span class="badge rounded-pill bg-secondary">Non traité: ${stats.nonTraite}</span>
                                          </div>
                                      </div>
                                      <div class="card-body p-0">
                                          <div class="table-responsive">
                                              <table class="table table-hover mb-0">
                                                  <thead class="table-light">
                                                      <tr>
                                                          <th>Titre</th>
                                                          <th>Typologie</th>
                                                          <th>Criticité</th>
                                                          <th>Statut</th>
                                                          <th>Solution</th>
                                                          <th>Délai</th>
                                                      </tr>
                                                  </thead>
                                                  <tbody>
                                                      ${data.map(probleme => `
                                                          <tr>
                                                              <td>${probleme.titre || 'Non spécifié'}</td>
                                                              <td>${probleme.typologie || '-'}</td>
                                                              <td>
                                                                  <span class="badge ${getCriticiteClass(probleme.criticite)}">
                                                                      ${probleme.criticite || 'Non évaluée'}
                                                                  </span>
                                                              </td>
                                                              <td>
                                                                  <span class="badge ${getStatutClass(probleme.statut_solution)}">
                                                                      ${probleme.statut_solution || 'Non traité'}
                                                                  </span>
                                                              </td>
                                                              <td>${probleme.solution_proposee || '-'}</td>
                                                              <td class="fw-bold ${probleme.delai_mise_en_oeuvre ? 'text-dark' : 'text-muted'}">
                                                                  ${probleme.delai_mise_en_oeuvre || 'N/D'}
                                                              </td>
                                                          </tr>
                                                      `).join('')}
                                                  </tbody>
                                              </table>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      `;

                      // Création des graphiques avec palette sobre
                      createCompactChart('typologieChart', typologieData, [
                          '#004600', '#006600', '#338033', '#66A366',
                          '#003300', '#005500', '#007700', '#009900'
                      ]);
                      
                      createCompactChart('criticiteChart', criticiteData, [
                          '#004600', // Haute criticité
                          '#66A366', // Moyenne
                          '#B3D9B3', // Faible
                          '#E0E0E0'  // Non évaluée
                      ]);
                  })
                  .catch(error => {
                      console.error('Erreur:', error);
                      container.innerHTML = `
                          <div class="alert alert-danger">
                              Erreur lors du chargement: ${error.message}
                              <button onclick="fetchProblemes(${composanteId})" class="btn btn-sm btn-outline-secondary ms-2">
                                  <i class="fas fa-sync-alt"></i> Réessayer
                              </button>
                          </div>
                      `;
                  });
          }

          function calculerDelaiMoyen(problemes) {
              const delaisValides = problemes
                  .filter(p => p.nombre_de_jours_retard && !isNaN(parseInt(p.nombre_de_jours_retard)))
                  .map(p => parseInt(p.nombre_de_jours_retard));
              
              if (delaisValides.length === 0) return null;
              
              const somme = delaisValides.reduce((a, b) => a + b, 0);
              return Math.round(somme / delaisValides.length);
          }

          function getStatutClass(statut) {
              if (!statut) return 'bg-secondary';
              statut = statut.toLowerCase();
              
              if (statut.includes('cloturé') || statut.includes('cloturé')) return 'bg-success';
              if (statut.includes('en cours')) return 'bg-warning text-dark';
              return 'bg-secondary';
          }

          function getCriticiteClass(criticite) {
              if (!criticite) return 'bg-secondary';
              criticite = criticite.toLowerCase();
              
              if (criticite.includes('haute')) return 'bg-dark text-white';
              if (criticite.includes('moyenne')) return 'bg-success';
              if (criticite.includes('faible')) return 'bg-light text-dark';
              return 'bg-light text-muted';
          }

          function createCompactChart(elementId, data, colors) {
              const ctx = document.getElementById(elementId);
              const total = Object.values(data).reduce((a, b) => a + b, 0);
              
              new Chart(ctx, {
                  type: 'doughnut',
                  data: {
                      labels: Object.keys(data),
                      datasets: [{
                          data: Object.values(data),
                          backgroundColor: colors,
                          borderWidth: 0,
                          cutout: '65%'
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                          legend: {
                              position: 'right',
                              labels: {
                                  boxWidth: 12,
                                  padding: 16,
                                  font: {
                                      size: 12
                                  }
                              }
                          },
                          tooltip: {
                              displayColors: false,
                              callbacks: {
                                  label: function(context) {
                                      const label = context.label || '';
                                      const value = context.raw || 0;
                                      const percentage = Math.round((value / total) * 100);
                                      return `${label}: ${value} (${percentage}%)`;
                                  }
                              }
                          },
                          // Plugin pour les étiquettes directes sur le graphique
                          datalabels: {
                              formatter: (value, context) => {
                                  const percentage = Math.round((value / total) * 100);
                                  return `${percentage}%`;
                              },
                              color: '#fff',
                              font: {
                                  weight: 'bold',
                                  size: 11
                              },
                              anchor: 'center',
                              align: 'center',
                              offset: 0,
                              clip: false
                          }
                      }
                  },
                  plugins: [ChartDataLabels] // Nécessite le plugin chartjs-plugin-datalabels
              });
          } 

          // Fonction helper pour les classes de criticité
          function getCriticiteClass(criticite) {
              if (!criticite) return 'bg-secondary';
              const levels = {
                  'Faible': 'bg-success',
                  'Moyenne': 'bg-warning text-dark',
                  'Haute': 'bg-danger',
                  'Elevée': 'bg-danger'
              };
              return levels[criticite] || 'bg-info';
          }
        });
      </script>
      <footer class="footer py-4  ">
        <div class="container-fluid">
          <div class="row align-items-center justify-content-lg-between">
            <div class="col-lg-6 mb-lg-0 mb-4">
              <div class="copyright text-center text-sm text-muted text-lg-start">
                © <script>
                  document.write(new Date().getFullYear())
                </script>, BOCS-primature
              </div>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </main>
  
  <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Variables pour les dropdowns
            const dropdownL1Button = document.getElementById('dropdownL1Button');
            const dropdownL2Button = document.getElementById('dropdownL2Button');
            const dropdownL3Button = document.getElementById('dropdownL3Button');
            const dropdownL3Button_1 = document.getElementById('dropdownL3Button_1');
            const dropdownL3Button_2 = document.getElementById('dropdownL3Button_2');
            const dropdownL4Button = document.getElementById('dropdownL4Button');
            const dropdownL4Button_1 = document.getElementById('dropdownL4Button_1');
            const dropdownL4Button_2 = document.getElementById('dropdownL4Button_2');
            const dropdownL5Button = document.getElementById('dropdownL5Button');
            const dropdownL5Button_1 = document.getElementById('dropdownL5Button_1');
            const dropdownL5Button_2 = document.getElementById('dropdownL5Button_2');

            const l2DropdownMenu = document.getElementById('l2DropdownMenu');
            const l3DropdownMenu = document.getElementById('l3DropdownMenu');
            const l3DropdownMenu_1 = document.getElementById('l3DropdownMenu_1');
            const l3DropdownMenu_2 = document.getElementById('l3DropdownMenu_2');
            const l4DropdownMenu = document.getElementById('l4DropdownMenu');
            const l4DropdownMenu_1 = document.getElementById('l4DropdownMenu_1');
            const l4DropdownMenu_2 = document.getElementById('l4DropdownMenu_2');
            const l5DropdownMenu = document.getElementById('l5DropdownMenu');
            const l5DropdownMenu_1 = document.getElementById('l5DropdownMenu_1');
            const l5DropdownMenu_2 = document.getElementById('l5DropdownMenu_2');

            // Variables pour stocker les valeurs sélectionnées
            let l1Value = 'all';
            let l2Value = null;
            let l3Value = null;
            let l3Value_1 = null;
            let l3Value_2 = null;
            let l4Value = null;
            let l4Value_1 = null;
            let l4Value_2 = null;
            let l5Value = null;
            let l5Value_1 = null;
            let l5Value_2 = null;

            // Fonction pour mettre à jour le filtre L1
            window.updateL1Filter = function(value, displayText) {
                l1Value = value;
                document.getElementById('selectedL1').textContent = displayText;
                resetFilters([dropdownL2Button, dropdownL3Button, dropdownL4Button, dropdownL5Button]);
                
                if (value !== 'all') {
                    fetchL2Options(value);
                } else {
                    fetchGlobalStats();
                }
            };
            
            // Fonction pour mettre à jour le filtre L2
            window.updateL2Filter = function(value, displayText) {
                l2Value = value;
                document.getElementById('selectedL2').textContent = displayText;
                resetFilters([dropdownL3Button, dropdownL4Button, dropdownL5Button]);
                
                if (value) {
                    fetchL3Options(l1Value, value);
                    fetchL3Options_1(l1Value, value);
                    fetchL3Options_2(l1Value, value);
                    fetchStats(l1Value, value);
                }
            };
            
            // Fonction pour mettre à jour le filtre L3
            window.updateL3Filter = function(value, displayText) {
                l3Value = value;
                document.getElementById('selectedL3').textContent = displayText;
                resetFilters([dropdownL4Button, dropdownL5Button]);
                
                if (value) {
                    fetchL4Options(value);
                }

            };
            
            window.updateL3Filter_1 = function(value, displayText) {
                l3Value_1 = value;
                document.getElementById('selectedL3_1').textContent = displayText;
                resetFilters([dropdownL4Button_1, dropdownL5Button_1]);
                
                if (value) {
                    fetchL4Options_1(value);
                }
                
            };

            window.updateL3Filter_2 = function(value, displayText) {
                l3Value_2 = value;
                document.getElementById('selectedL3_2').textContent = displayText;
                resetFilters([dropdownL4Button_2, dropdownL5Button_2]);
                
                if (value) {
                    fetchL4Options_2(value);
                }
                
            };
            // Fonction pour mettre à jour le filtre L4
            window.updateL4Filter = function(value, displayText) {
                l4Value = value;
                document.getElementById('selectedL4').textContent = displayText;
                resetFilters([dropdownL5Button]);
                
                if (value) {
                    fetchL5Options(value);
                }
            };

            window.updateL4Filter_1 = function(value, displayText) {
                l4Value_1 = value;
                document.getElementById('selectedL4_1').textContent = displayText;
                resetFilters([dropdownL5Button_1]);

                if (value) {
                    fetchL5Options_1(value);
                }
            };
            
            
            window.updateL4Filter_2 = function(value, displayText) {
                l4Value_2 = value;
                document.getElementById('selectedL4_2').textContent = displayText;
                resetFilters([dropdownL5Button_2]);

                if (value) {
                    fetchL5Options_2(value);
                }
            };
            

            // Fonction pour mettre à jour le filtre L5
            window.updateL5Filter = function(value, displayText) {
                l5Value = value;
                document.getElementById('selectedL5').textContent = displayText;
                
                if (value) {
                    fetchComposanteDetails(value);
                    fetchMessages(value);
                }
            };

            window.updateL5Filter_1 = function(value, displayText) {
                l5Value_1 = value;
                document.getElementById('selectedL5_1').textContent = displayText;

                if (value) {
                    fetchComposanteDetails_1(value);
                    fetchMessages_1(value);
                }
            };

            window.updateL5Filter_2 = function(value, displayText) {
                l5Value_2 = value;
                document.getElementById('selectedL5_2').textContent = displayText;

                if (value) {
                    fetchComposanteDetails_2(value);
                    fetchMessages_2(value);
                }
            };
            
            // Fonctions utilitaires
            function resetFilters(filters) {
                filters.forEach(filter => {
                    if (!filter) return; // Vérification si l'élément existe
                    
                    filter.disabled = true;
                    const spanId = filter.id.replace('dropdown', 'selected').replace('Button', '');
                    const spanElement = document.getElementById(spanId);
                    if (spanElement) {
                        spanElement.textContent = 'Sélectionnez d\'abord le niveau précédent';
                    }
                    
                    const menuId = filter.id.replace('Button', 'Menu');
                    const menu = document.getElementById(menuId);
                    if (menu) {
                        menu.innerHTML = '<li><a class="dropdown-item" href="#">Sélectionnez d\'abord le niveau précédent</a></li>';
                    }
                });
            }
            
            function fetchL2Options(l1Value) {
                const url = `/api/filters/l2/?l1=${l1Value}`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        dropdownL2Button.disabled = false;
                        document.getElementById('selectedL2').textContent = 'Sélectionnez une option';
                        
                        if (l2DropdownMenu) {
                            l2DropdownMenu.innerHTML = '';
                            data.options.forEach(option => {
                                const li = document.createElement('li');
                                const a = document.createElement('a');
                                a.className = 'dropdown-item';
                                a.href = '#';
                                a.textContent = option.name;
                                a.onclick = function() {
                                    updateL2Filter(option.id, option.name);
                                    return false;
                                };
                                li.appendChild(a);
                                l2DropdownMenu.appendChild(li);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching L2 options:', error);
                    });
            }
            
            function fetchL3Options(l1Value, l2Value) {
                const url = `/api/filters/l3/?l1=${l1Value}&l2=${l2Value}`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (dropdownL3Button) {
                            dropdownL3Button.disabled = false;
                        }
                        const selectedL3 = document.getElementById('selectedL3');
                        if (selectedL3) {
                            selectedL3.textContent = 'Sélectionnez un programme';
                        }
                        
                        if (l3DropdownMenu) {
                            l3DropdownMenu.innerHTML = '';
                            data.options.forEach(option => {
                                const li = document.createElement('li');
                                const a = document.createElement('a');
                                a.className = 'dropdown-item';
                                a.href = '#';
                                a.textContent = option.name;
                                a.onclick = function() {
                                    updateL3Filter(option.id, option.name);
                                    return false;
                                };
                                li.appendChild(a);
                                l3DropdownMenu.appendChild(li);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching L3 options:', error);
                    });
            }

            function fetchL3Options_1(l1Value, l2Value) {
                const url = `/api/filters/l3/?l1=${l1Value}&l2=${l2Value}`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (dropdownL3Button_1) {
                            dropdownL3Button_1.disabled = false;
                        }
                        const selectedL3_1 = document.getElementById('selectedL3_1');
                        if (selectedL3_1) {
                            selectedL3_1.textContent = 'Sélectionnez un programme';
                        }

                        if (l3DropdownMenu_1) {
                            l3DropdownMenu_1.innerHTML = '';
                            data.options.forEach(option => {
                                const li = document.createElement('li');
                                const a = document.createElement('a');
                                a.className = 'dropdown-item';
                                a.href = '#';
                                a.textContent = option.name;
                                a.onclick = function() {
                                    window.updateL3Filter_1(option.id, option.name);
                                    return false;
                                };
                                li.appendChild(a);
                                l3DropdownMenu_1.appendChild(li);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching L3 options:', error);
                    });
            }

            function fetchL3Options_2(l1Value, l2Value) {
                const url = `/api/filters/l3/?l1=${l1Value}&l2=${l2Value}`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (dropdownL3Button_2) {
                            dropdownL3Button_2.disabled = false;
                        }
                        const selectedL3_2 = document.getElementById('selectedL3_2');
                        if (selectedL3_2) {
                            selectedL3_2.textContent = 'Sélectionnez un programme';
                        }

                        if (l3DropdownMenu_2) {
                            l3DropdownMenu_2.innerHTML = '';
                            data.options.forEach(option => {
                                const li = document.createElement('li');
                                const a = document.createElement('a');
                                a.className = 'dropdown-item';
                                a.href = '#';
                                a.textContent = option.name;
                                a.onclick = function() {
                                    window.updateL3Filter_2(option.id, option.name);
                                    return false;
                                };
                                li.appendChild(a);
                                l3DropdownMenu_2.appendChild(li);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching L3 options:', error);
                    });
            }


            
            function fetchL4Options(l3Value) {
                const url = `/api/filters/l4/?l3=${l3Value}`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        dropdownL4Button.disabled = false;
                        document.getElementById('selectedL4').textContent = 'Sélectionnez un projet';
                        
                        if (l4DropdownMenu) {
                            l4DropdownMenu.innerHTML = '';
                            data.options.forEach(option => {
                                const li = document.createElement('li');
                                const a = document.createElement('a');
                                a.className = 'dropdown-item';
                                a.href = '#';
                                a.textContent = option.name;
                                a.onclick = function() {
                                    updateL4Filter(option.id, option.name);
                                    return false;
                                };
                                li.appendChild(a);
                                l4DropdownMenu.appendChild(li);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching L4 options:', error);
                    });
            }

            function fetchL4Options_1(l3Value_1) {
                const url = `/api/filters/l4/?l3=${l3Value_1}`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        dropdownL4Button_1.disabled = false;
                        document.getElementById('selectedL4_1').textContent = 'Sélectionnez un projet';
                        
                        if (l4DropdownMenu_1) {
                            l4DropdownMenu_1.innerHTML = '';
                            data.options.forEach(option => {
                                const li = document.createElement('li');
                                const a = document.createElement('a');
                                a.className = 'dropdown-item';
                                a.href = '#';
                                a.textContent = option.name;
                                a.onclick = function() {
                                    updateL4Filter_1(option.id, option.name);
                                    return false;
                                };
                                li.appendChild(a);
                                l4DropdownMenu_1.appendChild(li);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching L4 options:', error);
                    });
            }

            function fetchL4Options_2(l3Value_2) {
                const url = `/api/filters/l4/?l3=${l3Value_2}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        dropdownL4Button_2.disabled = false;
                        document.getElementById('selectedL4_2').textContent = 'Sélectionnez un projet';

                        if (l4DropdownMenu_2) {
                            l4DropdownMenu_2.innerHTML = '';
                            data.options.forEach(option => {
                                const li = document.createElement('li');
                                const a = document.createElement('a');
                                a.className = 'dropdown-item';
                                a.href = '#';
                                a.textContent = option.name;
                                a.onclick = function() {
                                    updateL4Filter_2(option.id, option.name);
                                    return false;
                                };
                                li.appendChild(a);
                                l4DropdownMenu_2.appendChild(li);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching L4 options:', error);
                    });
            }

            
            function fetchL5Options(l4Value) {
                const url = `/api/filters/l5/?l4=${l4Value}`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        dropdownL5Button.disabled = false;
                        document.getElementById('selectedL5').textContent = 'Sélectionnez une composante';
                        
                        if (l5DropdownMenu) {
                            l5DropdownMenu.innerHTML = '';
                            data.options.forEach(option => {
                                const li = document.createElement('li');
                                const a = document.createElement('a');
                                a.className = 'dropdown-item';
                                a.href = '#';
                                a.textContent = option.name;
                                a.onclick = function() {
                                    updateL5Filter(option.id, option.name);
                                    return false;
                                };
                                li.appendChild(a);
                                l5DropdownMenu.appendChild(li);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching L5 options:', error);
                        
                    });
            }

            function fetchL5Options_1(l4Value_1) {
                const url = `/api/filters/l5/?l4=${l4Value_1}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        dropdownL5Button_1.disabled = false;
                        document.getElementById('selectedL5_1').textContent = 'Sélectionnez une composante';

                        if (l5DropdownMenu_1) {
                            l5DropdownMenu_1.innerHTML = '';
                            data.options.forEach(option => {
                                const li = document.createElement('li');
                                const a = document.createElement('a');
                                a.className = 'dropdown-item';
                                a.href = '#';
                                a.textContent = option.name;
                                a.onclick = function() {
                                    updateL5Filter_1(option.id, option.name);
                                    return false;
                                };
                                li.appendChild(a);
                                l5DropdownMenu_1.appendChild(li);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching L5 options:', error);
                        return response.json();
                    });
            }

            function fetchL5Options_2(l4Value_2) {
                const url = `/api/filters/l5/?l4=${l4Value_2}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        dropdownL5Button_2.disabled = false;
                        document.getElementById('selectedL5_2').textContent = 'Sélectionnez une composante';

                        if (l5DropdownMenu_2) {
                            l5DropdownMenu_2.innerHTML = '';
                            data.options.forEach(option => {
                                const li = document.createElement('li');
                                const a = document.createElement('a');
                                a.className = 'dropdown-item';
                                a.href = '#';
                                a.textContent = option.name;
                                a.onclick = function() {
                                    updateL5Filter_2(option.id, option.name);
                                    return false;
                                };
                                li.appendChild(a);
                                l5DropdownMenu_2.appendChild(li);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching L5 options:', error);
                        return response.json();
                    });
            }
            // Les fonctions fetchStats, fetchGlobalStats, fetchComposanteDetails et fetchMessages restent inchangées
            // Fonction pour les statistiques filtrées
            function fetchStats(l1Value, l2Value) {
                const url = `/api/stats/?l1=${l1Value}&l2=${l2Value}`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.program_count !== undefined) {
                            const programCountEl = document.getElementById('program-count');
                            if (programCountEl) programCountEl.textContent = data.program_count;
                        }

                        if (data.project_count !== undefined) {
                            const projectCountEl = document.getElementById('project-count');
                            if (projectCountEl) projectCountEl.textContent = data.project_count;
                        }

                        if (data.started_project_count !== undefined) {
                            const startedProjectCountEl = document.getElementById('started-project-count');
                            if (startedProjectCountEl) startedProjectCountEl.textContent = data.started_project_count;
                        }

                        const startedcomposanteCount = document.getElementById('started-composante-count');
                        if (startedcomposanteCount && data.started_composante_count !== undefined) {
                            startedcomposanteCount.textContent = data.started_composante_count;
                        }

                        const SatisfaisantCount = document.getElementById('satisfaisant-composante-count');
                        if (SatisfaisantCount && data.satisfaisant_composante_count !== undefined) {
                            SatisfaisantCount.textContent = data.satisfaisant_composante_count;
                        }

                        const alertCount = document.getElementById('alerte-composante-count');
                        if (alertCount && data.alerte_composante_count !== undefined) {
                            alertCount.textContent = data.alerte_composante_count;
                        }

                        const bloqueCount = document.getElementById('bloque-composante-count');
                        if (bloqueCount && data.bloque_composante_count !== undefined) {
                            bloqueCount.textContent = data.bloque_composante_count;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching stats:', error);
                    });
            }


            // Fonction pour les statistiques globales
            function fetchGlobalStats() {
                const url = `/api/stats/global/`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        // Injection des valeurs globales
                        if (data.axe_count !== undefined) {
                            const axeCountEl = document.getElementById('axe-count');
                            if (axeCountEl) axeCountEl.textContent = data.axe_count;
                        }
                        
                        if (data.portefeuille_count !== undefined) {
                            const portefeuilleCountEl = document.getElementById('portefeuille-count');
                            if (portefeuilleCountEl) portefeuilleCountEl.textContent = data.portefeuille_count;
                        }
                        
                        if (data.program_count !== undefined) {
                            const programCountEl = document.getElementById('program-count');
                            if (programCountEl) programCountEl.textContent = data.program_count;
                        }
                        
                        if (data.project_count !== undefined) {
                            const projectCountEl = document.getElementById('project-count');
                            if (projectCountEl) projectCountEl.textContent = data.project_count;
                        }

                        if (data.started_composante_count !== undefined) {
                        const countElement = document.getElementById('started-composante-count');
                        if (countElement) countElement.textContent = data.started_composante_count;
                        } 

                        if (data.satisfaisant_composante_count !== undefined) {
                            const countElement = document.getElementById('satisfaisant-composante-count');
                            if (countElement) countElement.textContent = data.satisfaisant_composante_count;
                        }

                        if (data.alerte_composante_count !== undefined) {
                            const countElement = document.getElementById('alerte-composante-count');
                            if (countElement) countElement.textContent = data.alerte_composante_count;
                        }

                        if (data.bloque_composante_count !== undefined) {
                            const countElement = document.getElementById('bloque-composante-count');
                            if (countElement) countElement.textContent = data.bloque_composante_count;
                        }

                    })
                    .catch(error => {
                        console.error('Error fetching global stats:', error);
                    });
            }


            /*let composanteData = null;

            function fetchComposanteDetails(composanteId) {
                fetch(`/api/composantes/${composanteId}/`)
                    .then(response => response.json())
                    .then(data => {
                        composanteData = data;
                        // Afficher les infos générales
                        // document.getElementById('composante-nom').textContent = data.nom || '';
                        // document.getElementById('composante-localisation').textContent = data.localisation || '';
                        // document.getElementById('composante-tutelle').textContent = data.tutelle || '';
                        // document.getElementById('composante-statut').textContent = data.statut || '';
                        // Afficher le trimestre sélectionné par défaut
                        const nomElement = document.getElementById('composante-nom');
            
                        if (nomElement) nomElement.textContent = data.nom || 'Non renseigné';
                        updateTrimestreView(getSelectedTrimestre());
                    })
                    .catch(error => {
                        console.error('Erreur lors du chargement des détails de la composante:', error);
                    });
            }


            function getSelectedTrimestre() {
                const selected = document.querySelector('input[name="trimestre"]:checked');
                return selected ? selected.value : '1';  // T1 par défaut
            }

            function updateTrimestreView(trimestre) {
                if (!composanteData) return;

                document.getElementById('phy-reel').textContent = composanteData[`realise_t${trimestre}_total`] + '%' || '0%';
                document.getElementById('phy-prev').textContent = composanteData[`prev_t${trimestre}_total`] + '%' || '0%';
                document.getElementById('decaissement-reel').textContent = composanteData[`dec_reel_t${trimestre}`] + '%' || '0%';
                document.getElementById('decaissement-prev').textContent = composanteData[`dec_prev_t${trimestre}`] + '%' || '0%';
            }

            // Ajouter un écouteur sur tous les boutons radio
            document.querySelectorAll('input[name="trimestre"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    updateTrimestreView(radio.value);
                });
            });*/



				  
            let currentData0 = {}; // les données de la composante à stocker après fetch

            function fetchComposanteDetails(composanteId) {
                const url = `/api/composantes/${composanteId}/`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        currentData0 = data;
                        
                        const nomElement = document.getElementById('composante-tutelle');
                        if (nomElement) nomElement.textContent = data.tutelle || 'Non renseigné';

                        const imgElement_mise = document.getElementById("logoMise3");
                        const ministere_tutelle =currentData0.tutelle
                        if (imgElement_mise && ministere_tutelle) {
                          imgElement_mise.src = `/static/assets/img/logos/${ministere_tutelle}.png`;
                        }
                        updateDisplayForTrim0(getSelectedTrimestre()); // par défaut T2 est sélectionné
                    })
                    .catch(error => {
                        console.error('Erreur fetch composante :', error);
                    });
            }

            function updateDisplayForTrim0(trim) {
                if (!currentData0) return;

                const suffix = `t${trim}`;

                // Récupérer les valeurs
                const phyVal = currentData0[`realise_${suffix}_total`] || 0;
                const prevVal = currentData0[`prev_${suffix}_total`] || 0;
                const decReel = currentData0[`dec_reel_${suffix}`] || 0;
                const decPrev = currentData0[`dec_prev_${suffix}`] || 0;

                // Mise à jour du texte
                document.getElementById('phy-reel-val0').textContent = `${phyVal}%`;
                document.getElementById('phy-prev-val0').textContent = `${prevVal}%`;
                document.getElementById('dec-reel-val0').textContent = `${decReel}%`;
                document.getElementById('dec-prev-val0').textContent = `${decPrev}%`;

                // Mise à jour des cercles de progression
                updateProgressCircle('phy-reel-val0', phyVal);
                updateProgressCircle('phy-prev-val0', prevVal);
                updateProgressCircle('dec-reel-val0', decReel);
                updateProgressCircle('dec-prev-val0', decPrev);
            }

            function updateProgressCircle(elementId, percentage) {
                const container = document.getElementById(elementId).closest('.progress-circle-container');
                if (!container) return;
                
                // Find the fill path (updated to work with path instead of circle)
                const fillPath = container.querySelector('.circle-fill');
                if (!fillPath) return;
                
                // Calculate circumference for the path (assuming radius is ~15.9155 based on your path)
                const radius = 15.9155;
                const circumference = 2 * Math.PI * radius;
                const offset = circumference - (percentage / 100) * circumference;
                
                // Apply styles
                fillPath.style.strokeDasharray = `${circumference}`;
                fillPath.style.strokeDashoffset = offset;
                
                // Remove animation if it exists to prevent conflicts
                fillPath.style.animation = 'none';
            }

            // Initialisation des radios
            document.querySelectorAll('input[name="trimestre"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateDisplayForTrim0(this.value);
                });
            });

            // Fonction pour obtenir le trimestre sélectionné (à adapter selon votre implémentation)
            function getSelectedTrimestre() {
                const selectedRadio = document.querySelector('input[name="trimestre"]:checked');
                return selectedRadio ? selectedRadio.value : '2'; // T2 par défaut
            }




            function getSelectedTrimestre_2() {
                const selected = document.querySelector('input[name="trimestre_2"]:checked');
                return selected ? selected.value : '1';  // T1 par défaut
            } 

            // Données et fonctions pour la première colonne
            let currentData1 = {};

            function fetchComposanteDetails_1(composanteId) {
                const url = `/api/composantes/${composanteId}/`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        currentData1 = data;
                        const nomElement = document.getElementById('composante-tutelle-1');
                        if (nomElement) nomElement.textContent = data.tutelle || 'Non renseigné';
                        
                        const imgElement_mise = document.getElementById("logoMise1");
                        const ministere_tutelle = data.tutelle;
                        if (imgElement_mise && ministere_tutelle) {
                            imgElement_mise.src = `/static/assets/img/logos/${ministere_tutelle}.png`;
                        }
                        
                        updateDisplayForTrim1(getSelectedTrimestre_2());
                    })
                    .catch(error => {
                        console.error('Erreur fetch composante 1:', error);
                    });
            }

            function updateDisplayForTrim1(trim) {
                if (!currentData1) return;

                const suffix = `t${trim}`;

                // Récupérer les valeurs
                const phyVal = currentData1[`realise_${suffix}_total`] || 0;
                const prevVal = currentData1[`prev_${suffix}_total`] || 0;
                const decReel = currentData1[`dec_reel_${suffix}`] || 0;
                const decPrev = currentData1[`dec_prev_${suffix}`] || 0;

                // Mise à jour du texte
                const updateIfExists = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = `${value}%`;
                };

                updateIfExists('phy-reel-1', phyVal);
                updateIfExists('phy-prev-1', prevVal);
                updateIfExists('decaissement-reel-1', decReel);
                updateIfExists('decaissement-prev-1', decPrev);

                // Mise à jour des barres de progression
                const updateProgressBar = (barId, valId, value) => {
                    const bar = document.getElementById(barId);
                    const val = document.getElementById(valId);
                    if (bar && val) {
                        bar.style.width = `${value}%`;
                        val.textContent = `${value}%`;
                    }
                };

                updateProgressBar('phy-reel-bar1', 'phy-reel-val1', phyVal);
                updateProgressBar('phy-prev-bar1', 'phy-prev-val1', prevVal);
                updateProgressBar('dec-reel-bar1', 'dec-reel-val1', decReel);
                updateProgressBar('dec-prev-bar1', 'dec-prev-val1', decPrev);
            }

            // Données et fonctions pour la deuxième colonne
            let currentData2 = {};

            function fetchComposanteDetails_2(composanteId) {
                const url = `/api/composantes/${composanteId}/`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        currentData2 = data;
                        const nomElement = document.getElementById('composante-tutelle-2');
                        if (nomElement) nomElement.textContent = data.tutelle || 'Non renseigné';
                        
                        const imgElement_mise = document.getElementById("logoMise2");
                        const ministere_tutelle = data.tutelle;
                        if (imgElement_mise && ministere_tutelle) {
                            imgElement_mise.src = `/static/assets/img/logos/${ministere_tutelle}.png`;
                        }
                        
                        updateDisplayForTrim2(getSelectedTrimestre_2());
                    })
                    .catch(error => {
                        console.error('Erreur fetch composante 2:', error);
                    });
            }

            function updateDisplayForTrim2(trim) {
                if (!currentData2) return;

                const suffix = `t${trim}`;

                // Récupérer les valeurs
                const phyVal = currentData2[`realise_${suffix}_total`] || 0;
                const prevVal = currentData2[`prev_${suffix}_total`] || 0;
                const decReel = currentData2[`dec_reel_${suffix}`] || 0;
                const decPrev = currentData2[`dec_prev_${suffix}`] || 0;

                // Mise à jour du texte
                const updateIfExists = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = `${value}%`;
                };

                updateIfExists('phy-reel-2', phyVal);
                updateIfExists('phy-prev-2', prevVal);
                updateIfExists('decaissement-reel-2', decReel);
                updateIfExists('decaissement-prev-2', decPrev);

                // Mise à jour des barres de progression
                const updateProgressBar = (barId, valId, value) => {
                    const bar = document.getElementById(barId);
                    const val = document.getElementById(valId);
                    if (bar && val) {
                        bar.style.width = `${value}%`;
                        val.textContent = `${value}%`;
                    }
                };

                updateProgressBar('phy-reel-bar2', 'phy-reel-val2', phyVal);
                updateProgressBar('phy-prev-bar2', 'phy-prev-val2', prevVal);
                updateProgressBar('dec-reel-bar2', 'dec-reel-val2', decReel);
                updateProgressBar('dec-prev-bar2', 'dec-prev-val2', decPrev);
            }

            // Initialisation des radios pour les deux colonnes
            document.querySelectorAll('input[name="trimestre_2"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateDisplayForTrim1(this.value);
                    updateDisplayForTrim2(this.value);
                });
            });

            // Fonction pour les messages
            function fetchMessages(composanteId) {
                const url = `/api/messages/?composante=${composanteId}`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        const messagesContainer = document.getElementById('messages-container');
                        
                        if (!messagesContainer) return;
                        
                        if (data.length === 0) {
                            messagesContainer.innerHTML = '<p>Aucun message associé à cette composante</p>';
                            return;
                        }
                        
                        const latestMessage_0 = data[0];

                      let html = '<div class="list-group">';
                      html += `<p class="mb-1">${latestMessage_0.contenu}</p>`;
                      html += '</div>';
                      
                        
                        messagesContainer.innerHTML = html;
                    })
                    .catch(error => {
                        console.error('Error fetching messages:', error);
                    });
            }

            function fetchMessages_1(composanteId) {
                const url = `/api/messages/?composante=${composanteId}`;
                
              fetch(url)
                  .then(response => response.json())
                  .then(data => {
                      const messagesContainer_1 = document.getElementById('messages-container1');
                      
                      if (!messagesContainer_1) return;
                      
                      if (data.length === 0) {
                          messagesContainer_1.innerHTML = '<p>Aucun message associé à cette composante</p>';
                          return;
                      }
                      
                      // Prendre seulement le premier élément (le plus récent grâce au ordering dans le modèle)
                      const latestMessage = data[0];
                      
                      let html = '<div class="list-group">';
                      html += `<p class="mb-1">${latestMessage.contenu}</p>`;
                      html += '</div>';
                      
                      messagesContainer_1.innerHTML = html;
                  })
                  .catch(error => {
                      console.error('Error fetching messages:', error);
              });
            }



            function fetchMessages_2(composanteId) {
                const url = `/api/messages/?composante=${composanteId}`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        const messagesContainer_2 = document.getElementById('messages-container2');
                        
                        if (!messagesContainer_2) return;
                        
                        if (data.length === 0) {
                            messagesContainer_2.innerHTML = '<p>Aucun message associé à cette composante</p>';
                            return;
                        }
                        
                        const latestMessage_2 = data[0];

                        let html = '<div class="list-group">';
                        html += `<p class="mb-1">${latestMessage_2.contenu}</p>`;
                        html += '</div>';

                        messagesContainer_2.innerHTML = html;
                    })
                    .catch(error => {
                        console.error('Error fetching messages:', error);
                    });
            }
        });
  </script>


<script>
  $(document).ready(function() {
    var projets = [];
    var composantes = [];
    let trimestreSelectionne = $('input[name="trimestre"]:checked').val();

    // Charger les données des projets et composantes depuis le backend
  function loadData() {
    $.ajax({
      url: "{% url 'data_get_view' %}",
      type: "GET",
      dataType: "json",
      success: function(data) {
        projets = data.Projets;
        composantes = data.Composantes;

        var nomsProjets = [];
        for (var i = 0; i < projets.length; i++) {
          if (projets[i].nom && !nomsProjets.includes(projets[i].nom)) {
            nomsProjets.push(projets[i].nom);
          }
        }
        nomsProjets.sort();

        for (let idx = 0; idx < 6; idx++) {
          let listDeroulante1 = document.getElementById('listDeroulante1' + (idx === 0 ? '' : '_' + idx));
          let listDeroulante2 = document.getElementById('listDeroulante2' + (idx === 0 ? '' : '_' + idx));
          let selectionL1 = document.getElementById('selectionL1' + (idx === 0 ? '' : '_' + idx));
          let selectionL2 = document.getElementById('selectionL2' + (idx === 0 ? '' : '_' + idx));

          if (listDeroulante1 && listDeroulante2 && selectionL1 && selectionL2) {
            listDeroulante1.innerHTML = '';
            nomsProjets.forEach(function(nomProjet) {
              var li = document.createElement('li');
              var a = document.createElement('a');
              a.className = 'dropdown-item';
              a.href = '#';
              a.textContent = nomProjet;

              // Récupérer l'objet projet correspondant
              var projetObj = projets.find(p => p.nom === nomProjet);

              a.onclick = function(e) {
                e.preventDefault();

                // Affichage bouton projet
                selectionL1.querySelector('span') 
                  ? selectionL1.querySelector('span').textContent = nomProjet 
                  : selectionL1.textContent = nomProjet;

                var composantesProjet = composantes.filter(c => c.projet_id === projetObj.id);

                listDeroulante2.innerHTML = '';
                composantesProjet.forEach(function(comp) {
                  var liComp = document.createElement('li');
                  var aComp = document.createElement('a');
                  aComp.className = 'dropdown-item';
                  aComp.href = '#';
                  aComp.textContent = comp.nom;

                  aComp.onclick = function(e) {
                    e.preventDefault();

                    // Affichage bouton composante
                    selectionL2.querySelector('span') 
                      ? selectionL2.querySelector('span').textContent = comp.nom 
                      : selectionL2.textContent = comp.nom;

                    // Récupération des valeurs
                    var decPrevT1 = comp.dec_prev_t1 || 'N/A';
                    var decPrevT2 = comp.dec_prev_t2 || 'N/A';
                    var facteursExplication = comp.facteurs_explication || 'N/A';

                    updateTrimestreDisplay();

                  };

                  liComp.appendChild(aComp);
                  listDeroulante2.appendChild(liComp);
                });

                // Réinitialisation du bouton composante
                selectionL2.querySelector('span') 
                  ? selectionL2.querySelector('span').textContent = "Sélectionnez une composante"
                  : selectionL2.textContent = "Sélectionnez une composante";
              };
              li.appendChild(a);
              listDeroulante1.appendChild(li);
            });
          }
        }
      }
    });
  }

  function updateTrimestreDisplay() {
    for (let idx = 0; idx < 6; idx++) {
      let compNom = $("#selectionL2" + (idx === 0 ? '' : '_' + idx)).text().trim();

      if (!compNom || compNom === "Composante" || compNom === "Sélectionnez une composante") {
        continue; // si composante non sélectionnée
      }

      let comp = composantes.find(c => c.nom === compNom);

      if (comp) {
        let trimestre = trimestreSelectionne;
        let decPrev = comp[`prev_t${trimestre}_total`] || 'N/A';
        let realisePrec = comp[`realise_t${trimestre - 1}_total`] || 'N/A';
        let realiseActu = comp[`realise_t${trimestre}_total`] || 'N/A';
        let facteurs = comp.facteurs_explication || 'N/A';

        $("#prev_tn_total_" + idx).text(decPrev);
        $("#realise_tn_1_total_" + idx).text(realisePrec);
        $("#realise_tn_total_" + idx).text(realiseActu);
        $("#facteurs_explication_value_" + idx).text(facteurs);
      }
    }
  }

    // Appel initial
    loadData();
    $('input[name="trim"]').on('change', function () {
      trimestreSelectionne = $(this).val();
      updateTrimestreDisplay(); // Met à jour l’affichage
    });
  });

</script>

  {% endblock%}